"use strict";(self.webpackChunkembed_widget=self.webpackChunkembed_widget||[]).push([[411,9430],{56214:(e,t,a)=>{a.r(t),a.d(t,{default:()=>B});var n=a(9950),i=a(22332),o=a(80415),s=a(44414);function l(e){let{uploadFile:t}=e;return(0,s.jsx)("div",{className:"pb_cards",children:(0,s.jsxs)("div",{className:"pb_cards_box",children:[(0,s.jsxs)("div",{onClick:()=>t(3),className:"pb_card",children:[(0,s.jsx)("div",{className:"pb_card_icon",children:(0,s.jsx)("img",{src:`${o.on}images/photobooth/camera.svg`,alt:"camera"})}),(0,s.jsx)("h3",{className:"pb_card-title",children:"Photobooth"}),(0,s.jsx)("p",{className:"pb_card-description",children:" Add fun stickers and backgrounds before sharing your masterpiece."})]}),(0,s.jsxs)("div",{onClick:()=>t(2),className:"pb_card",children:[(0,s.jsx)("div",{className:"pb_card_icon",children:(0,s.jsx)("img",{src:`${o.on}images/photobooth/snapup.svg`,alt:"snapup"})}),(0,s.jsx)("h3",{className:"pb_card-title",children:"Snap & Share"}),(0,s.jsx)("p",{className:"pb_card-description",children:"Upload your photos in one go without logging into your social media accounts."})]})]})})}const r=e=>{let{className:t,children:a,icon:n,onClick:i}=e;return(0,s.jsxs)("button",{className:t,onClick:i,children:[n&&(0,s.jsx)("img",{src:`${o.on}images/photobooth/${n}.svg`,alt:n}),a]})};var c=a(11766),d=a.n(c);const h=()=>{const e=(0,n.useRef)(null),[t,a]=(0,n.useState)(null),[i,o]=(0,n.useState)({width:320,height:320,facingMode:"environment"}),l=(e,t,a)=>{if(e&&"string"===typeof e)if("blob"===t){const t=e.split(",")[1];if(!t||!/^[A-Za-z0-9+/=]+$/.test(t))return void console.error("Invalid base64 string:",t);const n=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"image/png";try{const a=e.split(",")[1];if(!a)throw new Error("No valid base64 data found in the string");const n=atob(a),i=new Array(n.length);for(let e=0;e<n.length;e++)i[e]=n.charCodeAt(e);const o=new Uint8Array(i);return new Blob([o],{type:t})}catch(a){return console.error("Base64 to Blob conversion error:",a),null}}(e);n?a(URL.createObjectURL(n)):console.error("Failed to create blob from base64")}else a(e);else console.error("Invalid imageSrc provided:",e)};(0,n.useEffect)(()=>{(async()=>{try{const e=(await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})).getVideoTracks()[0],t=e.getCapabilities();e.stop();const a=t.width.max,n=t.height.max;console.log("Max resolution detected:",a,"x",n);const i=Math.max(1280,n),s=Math.min(720,a);o({width:s,height:i,facingMode:"environment"})}catch(e){console.error("Error getting camera capabilities:",e),o({width:720,height:1280,facingMode:"environment"})}})()},[]);return(0,s.jsxs)("div",{style:{textAlign:"center",padding:"20px"},children:[(0,s.jsx)(d(),{audio:!1,ref:e,screenshotFormat:"image/png",videoConstraints:i,style:{width:"100%",maxWidth:`${i.width}px`,height:"auto"},onUserMediaError:e=>console.error("Webcam error:",e)}),(0,s.jsx)("button",{onClick:()=>{const t=e.current.getScreenshot({width:i.width,height:i.height,screenshotFormat:"image/png"});if(t){const e=new Image;e.src=t,e.onload=()=>{const t=document.createElement("canvas"),n=t.getContext("2d");t.width=i.width,t.height=i.height,n.drawImage(e,100,50,i.width-200,i.height-100,0,0,i.width,i.height);const o=t.toDataURL("image/png");l(o,"blob",e=>((e,t)=>{console.log("Taking photo:",e,"High Quality:",t),a(e)})(e,!0))}}else console.error("Failed to capture image. Check webcam permissions or availability.")},style:{margin:"10px",padding:"10px 20px"},children:"Capture Photo"}),t&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{children:"Preview:"}),(0,s.jsx)("img",{src:t,alt:"Captured",style:{width:"100%",maxWidth:`${i.width}px`,height:"auto",objectFit:"cover",display:"block",margin:"0 auto"}})]})]})},u=[{id:"background",label:"Background"},{id:"frame",label:"Frames"},{id:"sticker",label:"Stickers"},{id:"text",label:"Text"}],m=e=>{let{addSticker:t,loading:a,stickers:n,selectedStickers:i}=e;return(0,s.jsx)("div",{className:"pb_list_items pb_stickers",children:n.map((e,n)=>{const o=null===i||void 0===i?void 0:i.find(t=>(null===t||void 0===t?void 0:t.url)==e);return(0,s.jsx)("img",{onClick:a?null:()=>t(e),style:{cursor:a?"not-allowed":"pointer"},className:o?"active":"",src:`${e}?v=2.1`,alt:"sticker",width:64,height:64},n)})})};var g=a(25825);const v=["font","align","color","bg"],p=["Arial","Helvetica","Times New Roman","Georgia","Courier New","Verdana","Tahoma","Trebuchet MS","Comic Sans MS","Impact","Lucida Console","Roboto","Open Sans"],x=["left","center","right"],f=["white","black","transparent"],b=e=>{var t,a;let{canvasElements:i,setCanvasElements:l,activeTextIndex:r}=e;const[c,d]=(0,n.useState)(0),h=(0,n.useRef)(null);(0,n.useEffect)(()=>{const e=e=>{h.current&&!h.current.contains(e.target)&&d(!1)};return document.addEventListener("mousedown",e),document.addEventListener("touchstart",e),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}},[]);return(0,s.jsxs)("div",{className:"pb_text",children:[c?(0,s.jsxs)("div",{ref:h,style:{position:"absolute",zIndex:1e3,marginTop:"10px"},children:[(0,s.jsx)(g.xk,{color:null!==(t=null===(a=i[r])||void 0===a?void 0:a.color)&&void 0!==t?t:"black",onChange:e=>l(t=>t.map((t,a)=>a===r?{...t,color:e.hex}:t))})," "]}):null,v.map(e=>(0,s.jsxs)("div",{className:"pb_text_box",onClick:()=>(e=>{if(null!==r){const h={};if("color"===e)return void d(1);if("align"===e){var t,a;const e=null!==(t=null===(a=i[r])||void 0===a?void 0:a.align)&&void 0!==t?t:"center",n=x.find(t=>t===e);h.align=x[(x.indexOf(n)+1)%x.length]}else if("bg"===e){var n,o;const e=null!==(n=null===(o=i[r])||void 0===o?void 0:o.backgroundColor)&&void 0!==n?n:"transparent",t=f.find(t=>t===e);h.backgroundColor=f[(f.indexOf(t)+1)%f.length]}else if("font"===e){var s,c;const e=null!==(s=null===(c=i[r])||void 0===c?void 0:c.fontFamily)&&void 0!==s?s:"Arial",t=p.find(t=>t===e);h.fontFamily=p[(p.indexOf(t)+1)%p.length]}l(e=>e.map((e,t)=>t===r?{...e,...h}:e))}})(e),children:[(0,s.jsx)("img",{src:`${o.th}/media/images/photobooth/text/${e}.png?v=1`,alt:e}),(0,s.jsx)("p",{children:e})]},e))]})},w=e=>{let{loading:t,imgUrl:a,imgList:n,setImgUrl:i,tabKey:l,capturedImage:r=null}=e;return(0,s.jsx)("div",{className:`pb_list_items pb_${l}`,children:[`${o.th}/media/images/photobooth/${l}/none.png`,...n].map((e,n)=>{const o=a?a===e:0===n;return(0,s.jsxs)("div",{className:"pb_list_images "+(o?"active":""),children:[r&&0!==n?(0,s.jsx)("img",{className:"pb_list_user_img",src:null===r||void 0===r?void 0:r.src,alt:"captured-image",width:64,height:64}):null,(0,s.jsx)("img",{style:{cursor:t?"not-allowed":"pointer"},src:`${e}?v=2.1`,alt:`img-${n}`,className:"pb_list_frames",width:64,height:64,onClick:t?null:()=>i(0==n?null:e)})]},n)})})};var y=a(52867);const k=e=>{let{capturedImage:t,uploadFile:a,canvasRef:i,canvasCursor:l,selectedBg:c,setSelectedBg:d,selectedFrame:g,setSelectedFrame:v,addSticker:p,addTextElement:x,onMouseDown:f,onMouseMove:k,onMouseUp:S,canvasElements:_,setCanvasElements:M,activeTextIndex:j,loading:I,selectedStickers:C,photoBoothSettings:E,setActiveStickerIndex:N,setActiveTextIndex:A,activeText:T}=e;const[P,R]=(0,n.useState)("background"),[$,F]=(0,n.useState)([]),[B,L]=(0,n.useState)([]),[U,z]=(0,n.useState)([]);return(0,n.useEffect)(()=>{"text"===P&&x(),"text"!==P?A(null):"sticker"!==P&&N(null)},[P]),(0,n.useEffect)(()=>{const e=(0,y.S3)((null===E||void 0===E?void 0:E.photo_booth_frames)||[]),t=(0,y.S3)((null===E||void 0===E?void 0:E.photo_booth_backgrounds)||[]),a=(0,y.S3)((null===E||void 0===E?void 0:E.photo_booth_stickers)||[]);L(null===e||void 0===e?void 0:e.map(e=>`${o.on}images/photobooth/frames/${e}`)),F(null===t||void 0===t?void 0:t.map(e=>`${o.on}images/photobooth/backgrounds/${e}`)),z(null===a||void 0===a?void 0:a.map(e=>`${o.on}images/photobooth/stickers/${e}`))},[]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"pb_customization",children:[(0,s.jsx)(h,{loading:I,capturedImage:t,canvasRef:i,canvasCursor:l,onMouseDown:f,onMouseMove:k,onMouseUp:S,canvasElements:_,activeTextIndex:j,setCanvasElements:M,activeText:T}),(0,s.jsxs)("div",{className:"pb_tabs",children:[(0,s.jsx)("div",{className:"pb_tabs_list",children:u.map(e=>(0,s.jsx)("button",{onClick:()=>R(e.id),className:P===e.id?"active":"",children:e.label},e.id))}),(0,s.jsx)("div",{className:"pb_tabs_content",children:(0,s.jsx)("div",{className:"pb_tabs_content_box",children:"background"===P?(0,s.jsx)(w,{loading:I,imgUrl:c,imgList:$,setImgUrl:d,tabKey:"backgrounds"}):"frame"===P?(0,s.jsx)(w,{imgUrl:g,imgList:B,setImgUrl:v,tabKey:"frames",capturedImage:t}):"sticker"===P?(0,s.jsx)(m,{stickers:U,addSticker:p,loading:I,selectedStickers:C}):"text"===P?(0,s.jsx)(b,{canvasElements:_,setCanvasElements:M,activeTextIndex:j}):null})})]})]}),(0,s.jsx)("div",{className:"pb_continue_buttons_main",children:(0,s.jsx)(r,{className:"pb_continue_buttons",children:"Continue",onClick:()=>{if(null!==i&&void 0!==i&&i.current){const e=i.current;N(null),A(null),setTimeout(()=>{const t=e.toDataURL("image/png",1);t&&a(2,t)},100)}}})})]})};var S=a(66345);function _(e){const{snapType:t,uploadType:a,rawImage:n,capturedImage:i,wall:l,uploadImg:r,backAction:c}=e,d=1===t&&1===a||3===t&&!n&&!i;return(0,s.jsxs)("div",{className:"pb_header_bar",onClick:d?()=>window.location.href=`${S.EP}${l.Wall.id}?social-wall=true`:c,children:[(0,s.jsx)("img",{src:`${o.th}/media/images/photobooth/arrow-back.svg`,alt:"arrow-back"}),2==a&&r?(0,s.jsx)("img",{className:"pb_header_logo",src:l.PhotoBoothSettings.photo_booth_logo,height:20,width:130,alt:""}):(0,s.jsx)("span",{className:"header-title",children:d?"Back to Wall":"Back"})]})}const M=(e,t,a)=>{let n="blob"==t?((e,t)=>{try{const[a,n]=e.split(","),i=a.match(/:(.*?);/)[1],o=atob(n),s=o.length,l=new Uint8Array(s);for(let e=0;e<s;e++)l[e]=o.charCodeAt(e);return new File([l],t,{type:i})}catch(a){return console.error("Error converting base64 data to file:",a),null}})(e,"camera.png"):e;if(n){const e=URL.createObjectURL(n);e&&a&&a(e)}},j=(e,t,a)=>{const n=e.img.width*e.scale,i=e.img.height*e.scale,o=(e.rotation||0)*Math.PI/180,s=e.x+n/2,l=e.y+i/2,r=n/2,c=i/2,d=t-(s+(r*Math.cos(o)-c*Math.sin(o))),h=a-(l+(r*Math.sin(o)+c*Math.cos(o)));return Math.sqrt(d*d+h*h)<=T(15,7)/2},I=(e,t,a)=>{const n=e.img.width*e.scale,i=e.img.height*e.scale;return t>e.x&&t<e.x+n&&a>e.y&&a<e.y+i},C=(e,t,a)=>{const{img:n,scale:i,x:o,y:s,rotation:l=0}=e,r=n.width*i,c=n.height*i,d=o+r/2,h=s+c/2,u=r/2,m=-c/2-5,g=l*Math.PI/180,v=t-(d+u*Math.cos(g)-m*Math.sin(g)),p=a-(h+u*Math.sin(g)+m*Math.cos(g));return Math.sqrt(v*v+p*p)<=T(7,7)},E=(e,t,a,n)=>{const i=e.scale||1,o=e.fontSize||20,s=20*n,l=e.text.split("\n").length*o*i+20,r=e.x,c=e.y,d=(0,y.qs)()?i>0?20/i:20:0,h=t-r,u=a-c,m=(e.rotation||0)*Math.PI/180,g=Math.cos(-m),v=Math.sin(-m),p=(h*g-u*v)/i,x=(h*v+u*g)/i;return p>=-s/(2*i)&&p<=s/(2*i)&&x>=-l/(2*i)-d&&x<=l/(2*i)+d},N=(e,t,a,n)=>{var i;const o=e.scale||1,s=e.fontSize||20,l=(null===(i=e.text)||void 0===i?void 0:i.split("\n"))||[],r=1.2*s*Math.max(l.length,1)*o+20,c=n*o+20,d=T(16),h=e.x,u=e.y,m=c/2,g=r/2,v=(e.rotation||0)*Math.PI/180,p=t-(h+m*Math.cos(v)-g*Math.sin(v)),x=a-(u+m*Math.sin(v)+g*Math.cos(v));return p*p+x*x<(d/2)**2},A=(e,t,a,n)=>{var i;const o=e.scale||1,s=e.fontSize||20,l=T(16),r=e.x,c=e.y,d=(null===(i=e.text)||void 0===i?void 0:i.split("\n"))||[],h=(n*o+20)/2,u=-(1.2*s*Math.max(d.length,1)*o+20)/2,m=(e.rotation||0)*Math.PI/180,g=t-(r+h*Math.cos(m)-u*Math.sin(m)),v=a-(c+h*Math.sin(m)+u*Math.cos(m));return g*g+v*v<(l/2)**2},T=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(0,y.qs)()?2*e+t:e};var P=a(69522);const R=e=>{let{imageUrl:t,photoBtnRef:a,customiseImage:i}=e;const l=(0,n.useRef)(null),r=(0,n.useRef)(null),c=(0,n.useRef)(null),d=(0,n.useRef)(1),[h,u]=(0,n.useState)(!0),[m,g]=(0,n.useState)({width:200,height:200}),[v,p]=(0,n.useState)({x:0,y:0}),[x,f]=(0,n.useState)(1),b=320,w=320,y=(0,n.useCallback)(()=>{const e=r.current;if(!e)return console.error("Original image not loaded."),null;const t=e.naturalWidth/m.width,a=e.naturalHeight/m.height,n=-v.x/x*t,o=-v.y/x*a,s=b/x*t,l=w/x*a,c=document.createElement("canvas");c.width=b,c.height=w;c.getContext("2d").drawImage(e,n,o,s,l,0,0,b,w),c.toBlob(e=>{if(e){const t=new File([e],"capture.png",{type:"image/png"});i(t)}},"image/png")},[v,x,m,b,w]);(0,n.useEffect)(()=>{const e=new Image;e.crossOrigin="anonymous",e.onload=()=>{const t=e.width/e.height;let a=b,n=a/t;n>w&&(n=w,a=n*t),g({width:a,height:n}),p({x:(b-a)/2,y:(w-n)/2})},e.src=t},[t]);const k=m.width*x,S=m.height*x,_=e=>{const[t,a]=e,n=t.clientX-a.clientX,i=t.clientY-a.clientY;return Math.sqrt(n*n+i*i)},M=e=>{2===e.touches.length&&(c.current=_(e.touches),d.current=x)},j=e=>{if(2===e.touches.length){e.preventDefault();const t=_(e.touches),a=c.current,n=d.current;if(!a||!n)return;const i=t/a;let o=Math.max(1,n*i);f(o)}};return(0,n.useEffect)(()=>{const e=l.current;if(e)return e.addEventListener("touchstart",M,{passive:!1}),e.addEventListener("touchmove",j,{passive:!1}),()=>{e.removeEventListener("touchstart",M),e.removeEventListener("touchmove",j)}},[x]),(0,n.useEffect)(()=>{const e=setTimeout(()=>{u(!1)},2500);return()=>clearTimeout(e)},[]),(0,s.jsxs)("div",{ref:l,style:{width:b,height:w,border:"2px dashed #aaa",position:"relative",overflow:"hidden",margin:"0px auto 30px",background:"#f9f9f9",touchAction:"none",borderRadius:"8px"},onWheel:e=>{e.preventDefault();const t=e.deltaY<0?.05:-.05,a=Math.max(1,x+t);if(a<=1.01&&k<=b&&S<=w){f(1);const e=(b-m.width)/2,t=(w-m.height)/2;p({x:e,y:t})}else f(a)},children:[(0,s.jsx)(P.p,{size:{width:k,height:S},position:v,enableResizing:!1,disableDragging:!1,onDragStop:(e,t)=>{let a=t.x,n=t.y;const i=Math.max(0,k-b),o=Math.max(0,S-w);a=Math.min(Math.max(a,-i),0),n=Math.min(Math.max(n,-o),0),p({x:a,y:n})},style:{zIndex:2,pointerEvents:"auto"},children:(0,s.jsx)("img",{ref:r,src:t,alt:"Editable",style:{width:"100%",height:"100%",objectFit:"cover",userSelect:"none",pointerEvents:"none"}})}),(0,s.jsx)("button",{ref:a,style:{display:"none",position:"absolute",top:10,right:10,zIndex:400},onClick:y,children:"Capture"}),h?(0,s.jsxs)("div",{className:"pb_take_photo_crop",children:[(0,s.jsx)("img",{src:`${o.th}/media/images/photobooth/arrow-left.svg`,alt:"arrow-left",width:50,height:50}),(0,s.jsx)("img",{src:`${o.th}/media/images/photobooth/arrow-right.svg`,alt:"arrow-right",width:50,height:50})]}):null]})},$=e=>{var t;let{uploadType:a,rawImage:i,takePhoto:l,canvasRef:c,canvasCursor:d,setRawImage:u,customisePhoto:m}=e;const g=(0,n.useRef)(null),v=(0,n.useRef)(null),p=(0,n.useRef)(null),[x,f]=(0,n.useState)(null),[b,w]=(0,n.useState)("capture"),[y,k]=(0,n.useState)(0),[S,_]=(0,n.useState)(null),j=(0,n.useCallback)(async()=>{["Smile",3,2,1,0].forEach((e,t)=>{setTimeout(()=>f(e),1e3*t)})},[]),I=(0,n.useCallback)(()=>{w("capture"),u(null)},[]),C=(0,n.useCallback)(e=>{var t,a;const n=null===e||void 0===e||null===(t=e.target)||void 0===t||null===(a=t.files)||void 0===a?void 0:a[0];k(y+1),M(n,"file",e=>l(e,!0))},[y]),E=(0,n.useCallback)(async e=>{var t;w(e),"capture"===e&&await j(),"upload"===e&&null!==g&&void 0!==g&&g.current&&await(null===g||void 0===g||null===(t=g.current)||void 0===t?void 0:t.click())},[]);(0,n.useEffect)(async()=>{if(0==x&&null!==v&&void 0!==v&&v.current){var e;f(null);const t=document.createElement("canvas");console.log(t,"canvascanvascanvas");const a=await(null===v||void 0===v||null===(e=v.current)||void 0===e?void 0:e.getScreenshot());M(a,"blob",e=>l(e,!0))}},[x]);return(0,n.useEffect)(()=>{/Safari/i.test(navigator.userAgent)&&!/Chrome/i.test(navigator.userAgent)||(async()=>{try{const e=await navigator.mediaDevices.getUserMedia({video:!0});v.current&&(v.current.srcObject=e),_("granted")}catch(e){if(console.warn("Camera error:",e.name,e.message),navigator.permissions&&navigator.permissions.query)try{const e=await navigator.permissions.query({name:"camera"});return void _(e.state)}catch{console.log("Permissions API not supported (Safari likely)")}_("prompt")}})()},[]),(0,n.useEffect)(()=>{const e=async()=>{try{const e=await navigator.permissions.query({name:"camera"});e.state!==S&&_(e.state)}catch(e){console.warn("Permissions API not fully supported",e)}};return setInterval(e,2e3),()=>{clearInterval(e)}},[S]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"pb_user_photo_box",children:[i?(0,s.jsx)(R,{photoBtnRef:p,imageUrl:null!==(t=null===i||void 0===i?void 0:i.src)&&void 0!==t?t:"",customiseImage:e=>{M(e,"file",e=>l(e,!1)),setTimeout(m,100)}}):(0,s.jsxs)(s.Fragment,{children:[" ",(0,s.jsx)(h,{cameraPermission:S,mode:b,rawImage:i,canvasRef:c,canvasCursor:d,webcamRef:v,counter:x}),i?null:(0,s.jsxs)("div",{id:"camera-disabled-message",className:"pb-camera-disabled",style:{display:"granted"===S||i?"none":"flex"},children:[(0,s.jsx)("img",{src:`${o.on}images/photobooth/camera-disabled.svg`,alt:"camera-disabled"}),(0,s.jsxs)("p",{className:"pb_camera_disabled_text",children:["Please reload and allow camera",(0,s.jsx)("br",{}),"access when prompted."]}),(0,s.jsxs)("p",{className:"pb_camera_disabled_text_bottom",children:["In case this doesn't work, please",(0,s.jsx)("br",{}),"check the camera permissions in ",(0,s.jsx)("br",{}),"your browser settings."]})]})]}),i?(0,s.jsxs)("div",{className:"pb_take_photo",children:[(0,s.jsx)(r,{className:"pb_buttons_transparent",icon:"retake",children:"Try Again",onClick:I}),(0,s.jsx)(r,{className:"pb_buttons heighlight",children:"Looks Good!",onClick:()=>{var e;return null===p||void 0===p||null===(e=p.current)||void 0===e?void 0:e.click()}})]}):(0,s.jsxs)("div",{className:"pb_user_buttons",children:["granted"===S?(0,s.jsx)(r,{className:"pb_buttons heighlight",icon:"camera",children:"Strike a Pose",onClick:()=>E("capture")}):null,(0,s.jsx)(r,{className:"pb_buttons",icon:"upload",children:"Upload from Gallery",onClick:()=>E("upload")})]})]}),(0,s.jsx)("input",{ref:g,type:"file",accept:"image/*",style:{display:"none"},onChange:C},y)]})};var F=a(48768);const B=e=>{var t,a,o,r;const c=(0,n.useRef)(null),d=(0,n.useRef)({}),h=(0,n.useRef)({}),[u,m]=(0,n.useState)(!1),[g,v]=(0,n.useState)(null),[p,x]=(0,n.useState)(null),[f,b]=(0,n.useState)(!1),[w,S]=(0,n.useState)(0),[M,T]=(0,n.useState)(null),[P,R]=(0,n.useState)(null),[B,L]=(0,n.useState)(null),[U,z]=(0,n.useState)([]),[O,Y]=(0,n.useState)([]),[D,W]=(0,n.useState)(null),[X,q]=(0,n.useState)(null),[G,H]=(0,n.useState)(null),[K,V]=(0,n.useState)(null===e||void 0===e?void 0:e.snapType),[Q,Z]=(0,n.useState)(null),[J,ee]=(0,n.useState)(null),[te,ae]=(0,n.useState)(null),[ne,ie]=(0,n.useState)(null),[oe,se]=(0,n.useState)(null),[le,re]=(0,n.useState)("default"),[ce,de]=(0,n.useState)({width:2048,height:2048}),he=(0,n.useMemo)(y.qs,[]),ue=e=>{m(e)},me=e=>{const t=c.current,a=t.getBoundingClientRect();return{x:(e.clientX-a.left)*(t.width/a.width),y:(e.clientY-a.top)*(t.height/a.height)}},ge=e=>{const t=null===c||void 0===c?void 0:c.current;if(!t||null===e||void 0===e||!e.text)return 0;const a=t.getContext("2d");if(!a)return 0;a.save(),a.font=`${e.fontSize||20}px ${e.fontFamily||"Arial"}`;const n=e.text.split("\n"),i=Math.max(...n.map(e=>a.measureText(e).width));return a.restore(),i};(0,n.useEffect)(()=>{if(!p||!M)return;const e=c.current;if(!e)return;const t=e.getContext("2d"),a=ce.width,n=ce.height;e.width=a,e.height=n;const i=document.createElement("canvas");i.width=a,i.height=n;const o=i.getContext("2d");if(o.clearRect(0,0,a,n),D&&B){const e=document.createElement("canvas");e.width=a,e.height=n;const t=e.getContext("2d");t.drawImage(p,0,0,a,n),t.globalCompositeOperation="destination-in",t.drawImage(M,0,0,a,n),t.globalCompositeOperation="source-over",o.drawImage(B,0,0,a,n),o.drawImage(e,0,0,a,n)}else o.drawImage(p,0,0,a,n);o.globalCompositeOperation="source-over",P&&o.drawImage(P,0,0,a,n),U.forEach((e,t)=>{const a=e.img.width*e.scale,n=e.img.height*e.scale,i=e.x+a/2,s=e.y+n/2;if(o.save(),o.translate(i,s),o.rotate((e.rotation||0)*Math.PI/180),o.drawImage(e.img,-a/2,-n/2,a,n),t===te){o.strokeStyle="#2b2b2b",o.lineWidth=2,o.setLineDash([5,3]),o.strokeRect(-a/2,-n/2,a,n),o.setLineDash([]);const l=14,r="\u2921",c=a/2,h=n/2;o.fillStyle="#000",o.beginPath(),o.arc(c,h,l,0,2*Math.PI),o.fill(),o.fillStyle="white",o.font="bold 24px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText(r,c,h-2);const u=a/2,m=-n/2,g=14;o.beginPath(),o.fillStyle="#000",o.arc(u,m,g,0,2*Math.PI),o.fill(),o.fillStyle="#fff",o.font="bold 24px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText("\u27f3",u+1,m-1);const v=22,p=-a/2-v/2+5,x=-n/2-v/2+8;d.current[t]={x:i+p*Math.cos(e.rotation*Math.PI/180)-x*Math.sin(e.rotation*Math.PI/180),y:s+p*Math.sin(e.rotation*Math.PI/180)+x*Math.cos(e.rotation*Math.PI/180),size:v},o.beginPath(),o.arc(p+5,x+5,14,0,2*Math.PI),o.fillStyle="black",o.fill(),o.fillStyle="#fff",o.font="bold 14px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText("\u2715",p+5,x+5)}o.restore()}),O.forEach((e,t)=>{var a;o.save(),o.translate(e.x,e.y),o.rotate(e.rotation*Math.PI/180),o.scale(e.scale,e.scale),o.font=`${e.fontSize}px ${e.fontFamily||"Arial"}`,o.textAlign=e.align||"center",o.textBaseline="middle";const n=(null===(a=e.text)||void 0===a?void 0:a.split("\n"))||[""],i=Math.max(...n.map(e=>o.measureText(e).width)),s=n.length,l=e.fontSize*e.scale,r=i+20,c=l*s+10,d=1.2*l,u=i+20,m=l*n.length+30,g=-u/2;if(e.backgroundColor&&(o.fillStyle=e.backgroundColor,o.fillRect(g,-m/2,u,m)),t!==J&&(o.fillStyle=e.color||"#000000",n.forEach((e,t)=>{let a=0;"center"==o.textAlign?a=0:"left"==o.textAlign?a=-u/2+10:"right"==o.textAlign&&(a=u/2-10),o.fillText(e,a,t*d-(n.length-1)*d/2)})),t===J){o.strokeStyle="#2b2b2b",o.lineWidth=2,o.setLineDash([5,3]),o.strokeRect(g,-m/2,u,m),o.setLineDash([]);const a=22,n=(e.rotation||0)*Math.PI/180,i=-r/2-a/2,s=-c/2-a/2,l=e.x+i*Math.cos(n)-s*Math.sin(n),d=e.y+i*Math.sin(n)+s*Math.cos(n);h.current[t]={x:l,y:d,size:Math.max(he?15:10,a*e.scale)},o.fillStyle="black",o.beginPath(),o.arc(g,-m/2,14,0,2*Math.PI),o.fill(),o.fillStyle="#fff",o.font="bold 14px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText("\u2715",g,-m/2),o.fillStyle="black",o.beginPath(),o.arc(g+u,-m/2,14,0,2*Math.PI),o.fill(),o.fillStyle="white",o.font="bold 18px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText("\u27f3",g+u,-m/2),o.fillStyle="black",o.beginPath(),o.arc(g+u,m/2,14,0,2*Math.PI),o.fill(),o.fillStyle="white",o.font="bold 20px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText("\u2921",g+u,m/2)}o.restore()}),t.clearRect(0,0,a,n),t.drawImage(i,0,0)},[p,M,P,U,te,O,J,B,f,ce,K]),(0,n.useEffect)(()=>{if(!D)return void L(null);const e=new Image;e.crossOrigin="anonymous",e.src=`https://cdn.taggbox.com/v7/${D}?v=2.1`,ue(!0),e.onload=()=>{L(e),ue(!1)},e.onerror=()=>{console.error(`Failed to load background image: ${D}`),ue(!1)}},[D]),(0,n.useEffect)(()=>{if(!X)return void R(null);const e=new Image;e.crossOrigin="anonymous",e.src=`https://cdn.taggbox.com/v7/${X}?v=2.1`,ue(!0),e.onload=()=>{R(e),ue(!1)},e.onerror=()=>{console.error(`Failed to load frame image: ${X}`),ue(!1)}},[X]),(0,n.useEffect)(()=>{let e=0,t=!1;const a=[".pb_tabs_content_box",".pb_photo_booth_h_review"],n=n=>{e=n.touches[0].clientY;const i=n.target.closest(a.join(","));t=!!i},i=a=>{if(t)return;const n=document.documentElement.scrollTop||document.body.scrollTop,i=a.touches[0].clientY-e;0===n&&i>0&&a.preventDefault()};return document.addEventListener("touchstart",n,{passive:!1}),document.addEventListener("touchmove",i,{passive:!1}),()=>{document.removeEventListener("touchstart",n),document.removeEventListener("touchmove",i)}},[]);const ve=(e,t)=>{V(e),H(t),S(0)};return(0,s.jsx)("div",{className:"pb_photo_booth_main",children:(0,s.jsx)("div",{className:"pb_photo_booth_box",children:(0,s.jsxs)("div",{className:"pb_photo_booth_box_inner",children:[(0,s.jsx)(_,{snapType:e.snapType,rawImage:g,capturedImage:p,uploadImg:G,uploadType:K,wall:null===e||void 0===e?void 0:e.wall,backAction:()=>{f?(v(p),G&&!w?(b(!0),S(1),V(3),v(0)):(b(!1),S(0))):(b(!1),v(null),V(g?G&&2===K?3:K:null===e||void 0===e?void 0:e.snapType))}}),(0,s.jsx)("div",{className:"pb_photo_booth_h "+(2===K?"pb_photo_booth_h_review":""),children:1==K?(0,s.jsx)(l,{uploadFile:ve}):(0,s.jsx)(s.Fragment,{children:2===K?(0,s.jsx)(F.default,{isPhotoBooth:G,photoBoothInterface:1,wall:null===e||void 0===e?void 0:e.wall,wallId:null===e||void 0===e||null===(t=e.wall)||void 0===t||null===(a=t.Wall)||void 0===a?void 0:a.id,feeds:null===e||void 0===e?void 0:e.feeds,isFreeAdsStatus:null===e||void 0===e?void 0:e.isFreeAdsStatus}):f?(0,s.jsx)(k,{loading:u,capturedImage:p,uploadFile:ve,canvasRef:c,canvasCursor:le,selectedBg:D,setSelectedBg:W,selectedFrame:X,setSelectedFrame:q,addSticker:e=>{const t=new Image;t.crossOrigin="anonymous",ue(!0),t.src=`https://cdn.taggbox.com/v7/${e}?v=2.1`,t.onload=()=>{ue(!1);const a=ce.width,n=ce.height,i=t.height/t.width*100,o=100/t.width;ee(null),z(s=>{const l=[...s,{img:t,x:a/2-50,y:n/2-i/2,scale:o,url:e,rotation:0}];return ae(l.length-1),l})},t.onerror=()=>{ue(!1),console.error(`Failed to load sticker image: ${e}`)}},addTextElement:()=>{const e={text:"Your Text Here",x:ce.width/2,y:ce.height/2,scale:1,rotation:0,fontSize:28,fontFamily:"Georgia",color:"#000000",backgroundColor:"white",align:"center"};ae(null),Y(t=>{const a=[...t,e];return ee(a.length-1),a})},onMouseDown:e=>{const{x:t,y:a}=me(e);let n=!1,i=!1;for(let l=U.length-1;l>=0;l--){const e=U[l],i=d.current[l];if(i){const{x:e,y:n,size:o}=i,s=t-e,r=a-n;if(Math.sqrt(s*s+r*r)<o/2)return z(e=>e.filter((e,t)=>t!==l)),void ae(null)}if(C(e,t,a)){ae(l),ie("rotate"),se({x:t,y:a,centerX:e.x+e.img.width*e.scale/2,centerY:e.y+e.img.height*e.scale/2,initialAngle:e.rotation||0}),n=!0;break}if(j(e,t,a)){ae(l),ie("resize"),se({x:t,y:a,initialScale:e.scale,initialWidth:e.img.width}),n=!0;break}if(I(e,t,a)){ae(l),ie("move"),se({x:t,y:a,initialX:e.x,initialY:e.y}),n=!0;break}}if(!n)for(let l=O.length-1;l>=0;l--){var o;const e=O[l],n=ge(e),r=null===(o=h.current)||void 0===o?void 0:o[l];if(r){const{x:e,y:i}=r,o=O[l].scale||1,s=t-e,c=a-i;let d=.9;o<.5?d=3.5:o<.6?d=3:o<.7?d=2.4:o<.8?d=1.9:o<.93&&(d=1.6);if(Math.sqrt(s*s+c*c)/d<Math.max(20,.01*n*o))return Y(e=>e.filter((e,t)=>t!==l)),ee(null),void Z(null)}if(A(e,t,a,n)){ee(l),Z(null),ie("rotate-text"),se({x:t,y:a,centerX:e.x,centerY:e.y,initialAngle:e.rotation||0}),i=!0;break}if(N(e,t,a,n)){Z(null),ee(l),ae(null),ie("resize-text"),se({x:t,y:a,initialScale:e.scale,initialWidth:n}),i=!0;break}if(E(e,t,a,n)){var s;Z({index:l,count:J==l?(null===Q||void 0===Q?void 0:Q.count)>=2?2:(null!==(s=null===Q||void 0===Q?void 0:Q.count)&&void 0!==s?s:0)+1:1}),ee(l),ie("move-text"),se({x:t,y:a,initialX:e.x,initialY:e.y}),i=!0;break}}n||i||(ae(null),ee(null),ie(null),se(null),Z(null))},onMouseMove:e=>{const{x:t,y:a}=me(e);let n="default",i=!1;for(let l=O.length-1;l>=0;l--){const e=O[l],o=ge(e);if(A(e,t,a,o)){n="crosshair",i=!0;break}if(N(e,t,a,o)){n="nwse-resize",i=!0;break}if(E(e,t,a,o)){n="grab",i=!0;break}}if(!i)for(let l=U.length-1;l>=0;l--){const e=U[l];if(C(e,t,a)){n="crosshair",i=!0;break}if(j(e,t,a)){n="nwse-resize",i=!0;break}if(I(e,t,a)){n="grab",i=!0;break}}if("move"!==ne||null===te&&null===J||(n="grabbing"),re(n),!ne||!oe)return;const o=t-oe.x,s=a-oe.y;null!==te&&z(e=>{const n=[...e],i={...n[te]};if("move"===ne)i.x=oe.initialX+o,i.y=oe.initialY+s;else if("resize"===ne){const e=oe.initialWidth*oe.initialScale+o,t=Math.max(.05,e/i.img.width);i.scale=t}else if("rotate"===ne){const e=Math.atan2(oe.y-oe.centerY,oe.x-oe.centerX),n=180*(Math.atan2(a-oe.centerY,t-oe.centerX)-e)/Math.PI;i.rotation=(oe.initialAngle+n)%360}return n[te]=i,n}),null!==J&&Y(e=>{const n=[...e],i={...n[J]};if("move-text"===ne){const e=300;i.x=Math.max(0,Math.min(oe.initialX+o,e)),i.y=Math.max(0,Math.min(oe.initialY+s,e)),console.log("item",i.x,i.y)}else if("resize-text"===ne){const e=oe.initialWidth*oe.initialScale+o,t=Math.max(.1,e/ge(i));i.scale=t}else if("rotate-text"===ne){const e=Math.atan2(oe.y-oe.centerY,oe.x-oe.centerX),n=180*(Math.atan2(a-oe.centerY,t-oe.centerX)-e)/Math.PI;i.rotation=(oe.initialAngle+n)%360}return n[J]=i,n})},onMouseUp:()=>{ie(null),se(null),re("default")},canvasElements:O,setCanvasElements:Y,activeTextIndex:J,photoBoothSettings:null!==(o=null===e||void 0===e||null===(r=e.wall)||void 0===r?void 0:r.PhotoBoothSettings)&&void 0!==o?o:{},selectedStickers:U,setActiveStickerIndex:ae,setActiveTextIndex:ee,activeText:Q}):(0,s.jsx)($,{uploadType:K,rawImage:g,takePhoto:async(e,t)=>{if(!e)return void console.error("Failed to capture screenshot from webcam.");const a=new Image;a.crossOrigin="anonymous",a.src=e,a.onload=async()=>{t?v(a):x(a),de({width:a.width,height:a.height}),await(async e=>{const t=new i.SelfieSegmentation({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${e}`});t.setOptions({modelSelection:1}),t.onResults(e=>{T(e.segmentationMask)});const a=document.createElement("canvas");a.width=e.width,a.height=e.height,a.getContext("2d").drawImage(e,0,0,e.width,e.height);try{await t.send({image:a})}catch(n){console.error("Error sending image to MediaPipe:",n)}})(a)},a.onerror=()=>{console.error("Failed to load captured image.")}},canvasRef:c,canvasCursor:le,setRawImage:v,customisePhoto:()=>{v(null),R(null),L(null),z([]),Y([]),W(null),q(null),ee(null),ae(null),b(!0)}})})})]})})})}}}]);