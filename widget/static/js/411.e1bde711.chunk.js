"use strict";(self.webpackChunkembed_widget=self.webpackChunkembed_widget||[]).push([[411,9430],{56214:(e,t,a)=>{a.r(t),a.d(t,{default:()=>F});var n=a(9950),i=a(22332),l=a(80415),o=a(44414);function s(e){let{uploadFile:t}=e;return(0,o.jsx)("div",{className:"pb_cards",children:(0,o.jsxs)("div",{className:"pb_cards_box",children:[(0,o.jsxs)("div",{onClick:()=>t(3),className:"pb_card",children:[(0,o.jsx)("div",{className:"pb_card_icon",children:(0,o.jsx)("img",{src:`${l.th}/media/images/photobooth/camera.svg`,alt:"camera"})}),(0,o.jsx)("h3",{className:"pb_card-title",children:"Photobooth"}),(0,o.jsx)("p",{className:"pb_card-description",children:" Add fun filters and effects before you share your masterpiece."})]}),(0,o.jsxs)("div",{onClick:()=>t(2),className:"pb_card",children:[(0,o.jsx)("div",{className:"pb_card_icon",children:(0,o.jsx)("img",{src:`${l.th}/media/images/photobooth/snapup.svg`,alt:"snapup"})}),(0,o.jsx)("h3",{className:"pb_card-title",children:"Snap & Share"}),(0,o.jsx)("p",{className:"pb_card-description",children:"Scan the QR code to quickly and easily upload photos from your mobile."})]})]})})}const r=e=>{let{className:t,children:a,icon:n,onClick:i}=e;return(0,o.jsxs)("button",{className:t,onClick:i,children:[n&&(0,o.jsx)("img",{src:`${l.th}/media/images/photobooth/${n}.svg`,alt:n}),a]})};var c=a(11766),d=a.n(c);function h(){const e=(0,n.useRef)(null),[t,a]=(0,n.useState)(!1);return(0,o.jsx)("div",{style:{textAlign:"center"},children:t?(0,o.jsx)(d(),{ref:e,audio:!1,screenshotFormat:"image/png",videoConstraints:{facingMode:"user",width:{ideal:320},height:{ideal:320}},style:{width:"320px",height:"320px",objectFit:"cover",borderRadius:"8px"},mirrored:!0,playsInline:!0}):(0,o.jsx)("button",{onClick:()=>a(!0),children:"\ud83d\udcf7 Start Camera"})})}const u=e=>{let{addSticker:t,loading:a,stickers:n,selectedStickers:i}=e;return(0,o.jsx)("div",{className:"pb_stickers",children:n.map((e,n)=>{const l=null===i||void 0===i?void 0:i.find(t=>(null===t||void 0===t?void 0:t.url)==e);return(0,o.jsx)("img",{onClick:a?null:()=>t(e),style:{cursor:a?"not-allowed":"pointer"},className:l?"active":"",src:e,alt:"sticker",width:64,height:64},n)})})},m=["font","align","color","bg"],g=["Arial","Helvetica","Times New Roman","Georgia","Courier New","Verdana","Tahoma","Trebuchet MS","Comic Sans MS","Impact","Lucida Console","Roboto","Open Sans"],x=["left","center","right"],v=["white","black","transparent"],f=e=>{let{canvasElements:t,setCanvasElements:a,activeTextIndex:n}=e;return(0,o.jsx)("div",{className:"pb_text",children:m.map(e=>{var i,s;return(0,o.jsxs)("div",{className:"pb_text_box",children:[(0,o.jsx)("img",{src:`${l.th}/media/images/photobooth/text/${e}.png?v=1`,alt:e,onClick:()=>(e=>{if(null!==n){const d={};if("align"===e){var i,l;const e=null!==(i=null===(l=t[n])||void 0===l?void 0:l.align)&&void 0!==i?i:"center",a=x.find(t=>t===e);d.align=x[(x.indexOf(a)+1)%x.length]}else if("bg"===e){var o,s;const e=null!==(o=null===(s=t[n])||void 0===s?void 0:s.backgroundColor)&&void 0!==o?o:"transparent",a=v.find(t=>t===e);d.backgroundColor=v[(v.indexOf(a)+1)%v.length]}else if("font"===e){var r,c;const e=null!==(r=null===(c=t[n])||void 0===c?void 0:c.fontFamily)&&void 0!==r?r:"Arial",a=g.find(t=>t===e);d.fontFamily=g[(g.indexOf(a)+1)%g.length]}a(e=>e.map((e,t)=>t===n?{...e,...d}:e))}})(e)}),(0,o.jsx)("p",{children:e}),"color"===e&&(0,o.jsx)("input",{type:"color",value:null!==(i=null===(s=t[n])||void 0===s?void 0:s.color)&&void 0!==i?i:"black",onChange:e=>{const t=e.target.value;a(e=>e.map((e,a)=>a===n?{...e,color:t}:e))}})]},e)})})},p=e=>{let{loading:t,imgUrl:a,imgList:n,setImgUrl:i,tabKey:s}=e;return(0,o.jsx)("div",{className:`pb_${s}`,children:[`${l.th}/media/images/photobooth/${s}/none.png`,...n].map((e,n)=>{const l=a?a===e:0===n;return(0,o.jsx)("img",{style:{cursor:t?"not-allowed":"pointer"},src:e,alt:`img-${n}`,className:l?"active":"",width:64,height:64,onClick:t?null:()=>i(0==n?null:e)},n)})})},b=[{id:"background",label:"Background"},{id:"frame",label:"Frames"},{id:"sticker",label:"Stickers"},{id:"text",label:"Text"}];var w=a(52867);const y=e=>{let{capturedImage:t,uploadFile:a,canvasRef:i,canvasCursor:s,selectedBg:c,setSelectedBg:d,selectedFrame:m,setSelectedFrame:g,addSticker:x,addTextElement:v,onMouseDown:y,onMouseMove:k,onMouseUp:S,canvasElements:j,setCanvasElements:M,activeTextIndex:_,loading:I,selectedStickers:C,photoBoothSettings:N,setActiveStickerIndex:A,setActiveTextIndex:E}=e;const[P,R]=(0,n.useState)("background"),[T,$]=(0,n.useState)([]),[F,z]=(0,n.useState)([]),[B,U]=(0,n.useState)([]);return(0,n.useEffect)(()=>{"text"===P&&v(),"text"!==P?E(null):"sticker"!==P&&A(null)},[P]),(0,n.useEffect)(()=>{const e=(0,w.S3)((null===N||void 0===N?void 0:N.photo_booth_frames)||[]),t=(0,w.S3)((null===N||void 0===N?void 0:N.photo_booth_backgrounds)||[]),a=(0,w.S3)((null===N||void 0===N?void 0:N.photo_booth_stickers)||[]);z(null===e||void 0===e?void 0:e.map(e=>`${l.on}images/photobooth/frames/${e}`)),$(null===t||void 0===t?void 0:t.map(e=>`${l.on}images/photobooth/backgrounds/${e}`)),U(null===a||void 0===a?void 0:a.map(e=>`${l.on}images/photobooth/stickers/${e}`))},[]),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"pb_customization",children:[(0,o.jsx)(h,{loading:I,capturedImage:t,canvasRef:i,canvasCursor:s,onMouseDown:y,onMouseMove:k,onMouseUp:S,canvasElements:j,activeTextIndex:_,setCanvasElements:M}),(0,o.jsxs)("div",{className:"pb_tabs",children:[(0,o.jsx)("div",{className:"pb_tabs_list",children:b.map(e=>(0,o.jsx)("button",{onClick:()=>R(e.id),className:P===e.id?"active":"",children:e.label},e.id))}),(0,o.jsx)("div",{className:"pb_tabs_content",children:(0,o.jsx)("div",{className:"pb_tabs_content_box",children:"background"===P?(0,o.jsx)(p,{loading:I,imgUrl:c,imgList:T,setImgUrl:d,tabKey:"backgrounds"}):"frame"===P?(0,o.jsx)(p,{imgUrl:m,imgList:F,setImgUrl:g,tabKey:"frames"}):"sticker"===P?(0,o.jsx)(u,{stickers:B,addSticker:x,loading:I,selectedStickers:C}):"text"===P?(0,o.jsx)(f,{canvasElements:j,setCanvasElements:M,activeTextIndex:_}):null})})]})]}),(0,o.jsx)(r,{className:"pb_continue_buttons",children:"Continue",onClick:()=>{if(null!==i&&void 0!==i&&i.current){const e=i.current;A(null),E(null),setTimeout(()=>{const t=e.toDataURL("image/png");t&&a(2,t)},100)}}})]})};function k(e){return(0,o.jsxs)("div",{className:"pb_header_bar",onClick:e.backAction,children:[(0,o.jsx)("img",{src:`${l.th}/media/images/photobooth/arrow-back.svg`,alt:"arrow-back"}),2==e.uploadType&&e.uploadImg?(0,o.jsx)("img",{className:"pb_header_logo",src:e.wall.UgcSettings.onsite_logo,height:20,width:130,alt:""}):(0,o.jsx)("span",{className:"header-title",children:"Create a New Post"})]})}const S=(e,t,a)=>{let n="blob"==t?((e,t)=>{try{const a=e.split(","),n=a[0].match(/:(.*?);/)[1],i=atob(a[1]);let l=i.length;const o=new Uint8Array(l);for(;l--;)o[l]=i.charCodeAt(l);return new File([o],t,{type:n})}catch(a){return console.error("Error converting base64 data to file:",a),null}})(e,"camera.png"):e;if(n){const e=URL.createObjectURL(n);e&&a&&a(e)}},j=(e,t,a)=>{const n=e.img.width*e.scale,i=e.img.height*e.scale;return t>e.x+n-A(15,7)&&t<e.x+n&&a>e.y+i-A(15,7)&&a<e.y+i},M=(e,t,a)=>{const n=e.img.width*e.scale,i=e.img.height*e.scale;return t>e.x&&t<e.x+n&&a>e.y&&a<e.y+i},_=(e,t,a)=>{const{img:n,scale:i,x:l,y:o,rotation:s=0}=e,r=n.width*i,c=n.height*i,d=l+r/2,h=o+c/2,u=r/2,m=-c/2-5,g=s*Math.PI/180,x=t-(d+u*Math.cos(g)-m*Math.sin(g)),v=a-(h+u*Math.sin(g)+m*Math.cos(g));return Math.sqrt(x*x+v*v)<=A(7,7)},I=(e,t,a,n)=>{const i=e.scale||1,l=e.fontSize||20,o=n*A(20),s=e.text.split("\n").length*l*i+20,r=t-e.x,c=a-e.y,d=(e.rotation||0)*Math.PI/180,h=Math.cos(-d),u=Math.sin(-d),m=(r*h-c*u)/i,g=(r*u+c*h)/i;return m>=-o/(2*i)&&m<=o/(2*i)&&g>=-s/(2*i)&&g<=s/(2*i)},C=(e,t,a,n)=>{var i;const l=e.scale||1,o=e.fontSize||20,s=(null===(i=e.text)||void 0===i?void 0:i.split("\n"))||[],r=1.2*o*Math.max(s.length,1)*l+20,c=n*l+20,d=A(16),h=e.x,u=e.y,m=c/2,g=r/2,x=(e.rotation||0)*Math.PI/180,v=t-(h+m*Math.cos(x)-g*Math.sin(x)),f=a-(u+m*Math.sin(x)+g*Math.cos(x));return v*v+f*f<(d/2)**2},N=(e,t,a,n)=>{var i;const l=e.scale||1,o=e.fontSize||20,s=A(16),r=e.x,c=e.y,d=(null===(i=e.text)||void 0===i?void 0:i.split("\n"))||[],h=(n*l+20)/2,u=-(1.2*o*Math.max(d.length,1)*l+20)/2,m=(e.rotation||0)*Math.PI/180,g=t-(r+h*Math.cos(m)-u*Math.sin(m)),x=a-(c+h*Math.sin(m)+u*Math.cos(m));return g*g+x*x<(s/2)**2},A=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(0,w.qs)()?.75*e+t:e};var E=a(69522);const P=e=>{let{imageUrl:t,photoBtnRef:a,customiseImage:i}=e;const s=(0,n.useRef)(null),r=(0,n.useRef)(null),c=(0,n.useRef)(null),d=(0,n.useRef)(1),[h,u]=(0,n.useState)(!0),[m,g]=(0,n.useState)({width:200,height:200}),[x,v]=(0,n.useState)({x:0,y:0}),[f,p]=(0,n.useState)(1),b=320,w=320,y=(0,n.useCallback)(()=>{const e=r.current;if(!e)return console.error("Original image not loaded."),null;const t=document.createElement("canvas");t.width=b,t.height=w;const a=t.getContext("2d"),n=e.naturalWidth/m.width,l=e.naturalHeight/m.height,o=-x.x/f*n,s=-x.y/f*l,c=b/f*n,d=w/f*l;a.drawImage(e,o,s,c,d,0,0,b,w);const h=t.toDataURL("image/png");i(h)},[x,f,m,b,w]);(0,n.useEffect)(()=>{const e=new Image;e.crossOrigin="anonymous",e.onload=()=>{const t=e.width/e.height;let a=b,n=a/t;n>w&&(n=w,a=n*t),g({width:a,height:n}),v({x:(b-a)/2,y:(w-n)/2})},e.src=t},[t]);const k=m.width*f,S=m.height*f,j=e=>{const[t,a]=e,n=t.clientX-a.clientX,i=t.clientY-a.clientY;return Math.sqrt(n*n+i*i)},M=e=>{2===e.touches.length&&(c.current=j(e.touches),d.current=f)},_=e=>{if(2===e.touches.length){e.preventDefault();const t=j(e.touches),a=c.current,n=d.current;if(!a||!n)return;const i=t/a;let l=Math.max(1,n*i);p(l)}};return(0,n.useEffect)(()=>{const e=s.current;if(e)return e.addEventListener("touchstart",M,{passive:!1}),e.addEventListener("touchmove",_,{passive:!1}),()=>{e.removeEventListener("touchstart",M),e.removeEventListener("touchmove",_)}},[f]),(0,n.useEffect)(()=>{const e=setTimeout(()=>{u(!1)},2500);return()=>clearTimeout(e)},[]),(0,o.jsxs)("div",{ref:s,style:{width:b,height:w,border:"2px dashed #aaa",position:"relative",overflow:"hidden",margin:"0px auto 30px",background:"#f9f9f9",touchAction:"none",borderRadius:"8px"},onWheel:e=>{e.preventDefault();const t=e.deltaY<0?.05:-.05,a=Math.max(1,f+t);if(a<=1.01&&k<=b&&S<=w){p(1);const e=(b-m.width)/2,t=(w-m.height)/2;v({x:e,y:t})}else p(a)},children:[(0,o.jsx)(E.p,{size:{width:k,height:S},position:x,enableResizing:!1,disableDragging:!1,onDragStop:(e,t)=>{let a=t.x,n=t.y;const i=Math.max(0,k-b),l=Math.max(0,S-w);a=Math.min(Math.max(a,-i),0),n=Math.min(Math.max(n,-l),0),v({x:a,y:n})},style:{zIndex:2,pointerEvents:"auto"},children:(0,o.jsx)("img",{ref:r,src:t,alt:"Editable",style:{width:"100%",height:"100%",objectFit:"cover",userSelect:"none",pointerEvents:"none"}})}),(0,o.jsx)("button",{ref:a,style:{display:"none",position:"absolute",top:10,right:10,zIndex:400},onClick:y,children:"Capture"}),h?(0,o.jsxs)("div",{className:"pb_take_photo_crop",children:[(0,o.jsx)("img",{src:`${l.th}/media/images/photobooth/arrow-left.svg`,alt:"arrow-left",width:50,height:50}),(0,o.jsx)("img",{src:`${l.th}/media/images/photobooth/arrow-right.svg`,alt:"arrow-right",width:50,height:50})]}):null]})},R=e=>{var t;let{rawImage:a,takePhoto:i,canvasRef:s,canvasCursor:c,setRawImage:d,customisePhoto:u}=e;const m=(0,n.useRef)(null),g=(0,n.useRef)(null),x=(0,n.useRef)(null),[v,f]=(0,n.useState)(null),[p,b]=(0,n.useState)("capture"),[w,y]=(0,n.useState)(0),[k,j]=(0,n.useState)(null),M=(0,n.useCallback)(async()=>{["Smile",3,2,1,0].forEach((e,t)=>{setTimeout(()=>f(e),1e3*t)})},[]),_=(0,n.useCallback)(()=>{b("capture"),d(null)},[]),I=(0,n.useCallback)(e=>{var t,a;const n=null===e||void 0===e||null===(t=e.target)||void 0===t||null===(a=t.files)||void 0===a?void 0:a[0];y(w+1),S(n,"file",e=>i(e,!0))},[w]),C=(0,n.useCallback)(async e=>{var t;b(e),"capture"===e&&await M(),"upload"===e&&null!==m&&void 0!==m&&m.current&&await(null===m||void 0===m||null===(t=m.current)||void 0===t?void 0:t.click())},[]),N=(0,n.useMemo)(()=>{const e=navigator.userAgent.toLowerCase(),t=/iphone|ipad|ipod|android/.test(e),a=/android/.test(e),n=e.includes("chrome")&&!e.includes("edg"),i=e.includes("edg");let l=null;return t?a&&n&&(l="chrome://settings/content/camera"):n?l="chrome://settings/content/camera":i&&(l="edge://settings/content/camera"),l},[]);(0,n.useEffect)(async()=>{if(0==v&&null!==g&&void 0!==g&&g.current){var e;f(null);const t=await(null===g||void 0===g||null===(e=g.current)||void 0===e?void 0:e.getScreenshot());S(t,"blob",e=>i(e,!0))}},[v]);const A=()=>{g.current&&g.current.srcObject&&(g.current.srcObject.getTracks().forEach(e=>e.stop()),g.current.srcObject=null)};return(0,n.useEffect)(()=>(/Safari/i.test(navigator.userAgent)&&!/Chrome/i.test(navigator.userAgent)||(async()=>{try{A();const e=await navigator.mediaDevices.getUserMedia({video:!0});g.current&&(g.current.srcObject=e),j("granted")}catch(e){if(console.warn("Camera error:",e.name,e.message),navigator.permissions&&navigator.permissions.query)try{const e=await navigator.permissions.query({name:"camera"});if("denied"===e.state)return void j("denied");if("prompt"===e.state)return void j("prompt")}catch{console.log("Permissions API not supported (Safari likely)")}j("prompt")}})(),()=>A()),[]),(0,n.useEffect)(()=>{const e=async()=>{try{const e=await navigator.permissions.query({name:"camera"});e.state!==k&&j(e.state)}catch(e){console.warn("Permissions API not fully supported",e)}};return setInterval(e,2e3),()=>{clearInterval(e)}},[k]),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"pb_user_photo_box",children:[a?(0,o.jsx)(P,{photoBtnRef:x,imageUrl:null!==(t=null===a||void 0===a?void 0:a.src)&&void 0!==t?t:"",customiseImage:e=>{S(e,"blob",e=>i(e,!1)),setTimeout(u,100)}}):"granted"===k?(0,o.jsx)(h,{mode:p,rawImage:a,canvasRef:s,canvasCursor:c,webcamRef:g,counter:v}):(0,o.jsxs)("div",{id:"camera-disabled-message",className:"pb-camera-disabled",children:[(0,o.jsx)("img",{src:`${l.th}/media/images/photobooth/camera-disabled.svg`,alt:"camera-disabled"}),(0,o.jsxs)("p",{className:"pb_camera_disabled_text",children:["Please reload and allow camera",(0,o.jsx)("br",{}),"access when prompted."]}),N?(0,o.jsxs)("button",{id:"open-settings-button",onClick:()=>window.open(N,"_blank"),children:[(0,o.jsx)("img",{src:`${l.th}/media/images/photobooth/refresh.svg`,alt:"refresh",width:"20",height:"20"})," Reload Now"]}):null,(0,o.jsxs)("p",{className:"pb_camera_disabled_text_bottom",children:["In case this doesn't work, please",(0,o.jsx)("br",{}),"check the camera permissions in ",(0,o.jsx)("br",{}),"your browser settings."]})]}),a?(0,o.jsxs)("div",{className:"pb_take_photo",children:[(0,o.jsx)(r,{className:"pb_buttons_transparent",icon:"retake",children:"Retake",onClick:_}),(0,o.jsx)(r,{className:"pb_buttons heighlight",children:"Use Photo",onClick:()=>{var e;return null===x||void 0===x||null===(e=x.current)||void 0===e?void 0:e.click()}})]}):(0,o.jsxs)("div",{className:"pb_user_buttons",children:["granted"===k?(0,o.jsx)(r,{className:"pb_buttons heighlight",icon:"camera",children:"Capture Photo",onClick:()=>C("capture")}):null,(0,o.jsx)(r,{className:"pb_buttons",icon:"upload",children:"Upload From Gallery",onClick:()=>C("upload")})]})]}),(0,o.jsx)("input",{ref:m,type:"file",accept:"image/*",style:{display:"none"},onChange:I},w)]})};var T=a(48768);const $="Your Text Here",F=e=>{var t,a,l,r;const c=(0,n.useRef)(null),d=(0,n.useRef)({}),h=(0,n.useRef)({}),[u,m]=(0,n.useState)(!1),[g,x]=(0,n.useState)(null),[v,f]=(0,n.useState)(null),[p,b]=(0,n.useState)(!1),[w,S]=(0,n.useState)(0),[A,E]=(0,n.useState)(null),[P,F]=(0,n.useState)(null),[z,B]=(0,n.useState)(null),[U,O]=(0,n.useState)([]),[L,Y]=(0,n.useState)([]),[D,X]=(0,n.useState)(null),[q,W]=(0,n.useState)(null),[H,K]=(0,n.useState)(null),[G,Q]=(0,n.useState)(null===e||void 0===e?void 0:e.snapType),[V,J]=(0,n.useState)(null),[Z,ee]=(0,n.useState)(null),[te,ae]=(0,n.useState)(null),[ne,ie]=(0,n.useState)(null),[le,oe]=(0,n.useState)("default"),[se,re]=(0,n.useState)({width:320,height:320}),ce=e=>{m(e)},de=e=>{const t=c.current,a=t.getBoundingClientRect();return{x:(e.clientX-a.left)*(t.width/a.width),y:(e.clientY-a.top)*(t.height/a.height)}},he=e=>{const t=null===c||void 0===c?void 0:c.current;if(!t||null===e||void 0===e||!e.text)return 0;const a=t.getContext("2d");if(!a)return 0;a.save(),a.font=`${e.fontSize||20}px ${e.fontFamily||"Arial"}`;const n=e.text.split("\n"),i=Math.max(...n.map(e=>a.measureText(e).width));return a.restore(),i};(0,n.useEffect)(()=>{if(!v||!A)return;const e=c.current;if(!e)return;const t=e.getContext("2d"),a=se.width,n=se.height;e.width=a,e.height=n;const i=document.createElement("canvas");i.width=a,i.height=n;const l=i.getContext("2d");if(l.clearRect(0,0,a,n),D&&z){const e=document.createElement("canvas");e.width=a,e.height=n;const t=e.getContext("2d");t.drawImage(v,0,0,a,n),t.globalCompositeOperation="destination-in",t.drawImage(A,0,0,a,n),t.globalCompositeOperation="source-over",l.drawImage(z,0,0,a,n),l.drawImage(e,0,0,a,n)}else l.drawImage(v,0,0,a,n);l.globalCompositeOperation="source-over",P&&l.drawImage(P,0,0,a,n),U.forEach((e,t)=>{const a=e.img.width*e.scale,n=e.img.height*e.scale,i=e.x+a/2,o=e.y+n/2;if(l.save(),l.translate(i,o),l.rotate((e.rotation||0)*Math.PI/180),l.drawImage(e.img,-a/2,-n/2,a,n),t===Z){l.strokeStyle="#2b2b2b",l.lineWidth=2,l.setLineDash([5,3]),l.strokeRect(-a/2,-n/2,a,n),l.setLineDash([]);const s=8,r="\u2921",c=a/2,h=n/2;l.fillStyle="#000",l.beginPath(),l.arc(c,h,s,0,2*Math.PI),l.fill(),l.fillStyle="white",l.font="bold 16px Arial",l.textAlign="center",l.textBaseline="middle",l.fillText(r,c,h);const u=a/2,m=-n/2-20+20,g=8;l.beginPath(),l.fillStyle="#000",l.arc(u,m,g,0,2*Math.PI),l.fill(),l.fillStyle="#fff",l.font="bold 16px Arial",l.textAlign="center",l.textBaseline="middle",l.fillText("\u27f3",u,m);const x=22,v=-a/2-x/2+5,f=-n/2-x/2+8;d.current[t]={x:i+v*Math.cos(e.rotation*Math.PI/180)-f*Math.sin(e.rotation*Math.PI/180),y:o+v*Math.sin(e.rotation*Math.PI/180)+f*Math.cos(e.rotation*Math.PI/180),size:x},l.beginPath(),l.arc(v,f,8,0,2*Math.PI),l.fillStyle="black",l.fill(),l.fillStyle="#fff",l.font="bold 9px Arial",l.textAlign="center",l.textBaseline="middle",l.fillText("\u2715",v,f)}l.restore()}),L.forEach((e,t)=>{var a;l.save(),l.translate(e.x,e.y),l.rotate(e.rotation*Math.PI/180),l.scale(e.scale,e.scale),l.font=`${e.fontSize}px ${e.fontFamily||"Arial"}`,l.textAlign=e.align||"center",l.textBaseline="middle";const n=(null===(a=e.text)||void 0===a?void 0:a.split("\n"))||[""],i=Math.max(...n.map(e=>l.measureText(e).width)),o=n.length,s=e.fontSize*e.scale,r=i+20,c=s*o+10,d=1.2*s,u=i+20,m=s*n.length+30,g=-u/2;if(e.backgroundColor&&(l.fillStyle=e.backgroundColor,l.fillRect(g,-m/2,u,m)),t!==V&&(l.fillStyle=e.color||"#000000",n.forEach((e,t)=>{let a=0;"center"==l.textAlign?a=0:"left"==l.textAlign?a=-u/2+10:"right"==l.textAlign&&(a=u/2-10),l.fillText(e,a,t*d-(n.length-1)*d/2)})),t===V){const a=document.getElementById(`text-${V}`);a&&e.text==$&&(a.focus(),a.select()),l.strokeStyle="#2b2b2b",l.lineWidth=2,l.setLineDash([5,3]),l.strokeRect(g,-m/2,u,m),l.setLineDash([]);const n=22,i=(e.rotation||0)*Math.PI/180,o=-r/2-n/2,s=-c/2-n/2,d=e.x+o*Math.cos(i)-s*Math.sin(i),x=e.y+o*Math.sin(i)+s*Math.cos(i);h.current[t]={x:d,y:x,size:Math.max(10,n*e.scale)},l.fillStyle="black",l.beginPath(),l.arc(g,-m/2,8,0,2*Math.PI),l.fill(),l.fillStyle="#fff",l.font="bold 10px Arial",l.textAlign="center",l.textBaseline="middle",l.fillText("\u2715",g,-m/2),l.fillStyle="black",l.beginPath(),l.arc(g+u,-m/2,8,0,2*Math.PI),l.fill(),l.fillStyle="white",l.font="bold 14px Arial",l.textAlign="center",l.textBaseline="middle",l.fillText("\u27f3",g+u,-m/2),l.fillStyle="black",l.beginPath(),l.arc(g+u,m/2,8,0,2*Math.PI),l.fill(),l.fillStyle="white",l.font="bold 14px Arial",l.textAlign="center",l.textBaseline="middle",l.fillText("\u2921",g+u,m/2)}l.restore()}),t.clearRect(0,0,a,n),t.drawImage(i,0,0)},[v,A,P,U,Z,L,V,z,p,se]),(0,n.useEffect)(()=>{if(!D)return void B(null);const e=new Image;e.crossOrigin="anonymous",e.src=`https://cdn.taggbox.com/v7/${D}`,ce(!0),e.onload=()=>{B(e),ce(!1)},e.onerror=()=>{console.error(`Failed to load background image: ${D}`),ce(!1)}},[D]),(0,n.useEffect)(()=>{if(!q)return void F(null);const e=new Image;e.crossOrigin="anonymous",e.src=`https://cdn.taggbox.com/v7/${q}`,ce(!0),e.onload=()=>{F(e),ce(!1)},e.onerror=()=>{console.error(`Failed to load frame image: ${q}`),ce(!1)}},[q]);const ue=(e,t)=>{Q(e),K(t)};return(0,o.jsx)("div",{className:"pb_photo_booth_main",children:(0,o.jsx)("div",{className:"pb_photo_booth_box",children:(0,o.jsxs)("div",{className:"pb_photo_booth_box_inner",children:[(0,o.jsx)(k,{uploadImg:H,uploadType:G,wall:null===e||void 0===e?void 0:e.wall,backAction:()=>{p?(x(v),H&&!w?(b(!0),S(1),Q(3)):(b(!1),S(0))):(b(!1),x(null),Q(g?H&&2===G?3:G:null===e||void 0===e?void 0:e.snapType))}}),(0,o.jsx)("div",{className:"pb_photo_booth_h "+(p?"":"pb_photo_booth_h_center"),children:1==G?(0,o.jsx)(s,{uploadFile:ue}):(0,o.jsx)(o.Fragment,{children:2===G?(0,o.jsx)(T.default,{isPhotoBooth:H,photoBoothInterface:1,wall:null===e||void 0===e?void 0:e.wall,wallId:null===e||void 0===e||null===(t=e.wall)||void 0===t||null===(a=t.Wall)||void 0===a?void 0:a.id,feeds:null===e||void 0===e?void 0:e.feeds,isFreeAdsStatus:null===e||void 0===e?void 0:e.isFreeAdsStatus}):p?(0,o.jsx)(y,{loading:u,capturedImage:v,uploadFile:ue,canvasRef:c,canvasCursor:le,selectedBg:D,setSelectedBg:X,selectedFrame:q,setSelectedFrame:W,addSticker:e=>{const t=new Image;t.crossOrigin="anonymous",ce(!0),t.src=`https://cdn.taggbox.com/v7/${e}`,t.onload=()=>{ce(!1);const a=se.width,n=se.height,i=t.height/t.width*100,l=100/t.width;J(null),O(o=>{const s=[...o,{img:t,x:a/2-50,y:n/2-i/2,scale:l,url:e,rotation:0}];return ee(s.length-1),s})},t.onerror=()=>{ce(!1),console.error(`Failed to load sticker image: ${e}`)}},addTextElement:()=>{const e=se.width,t=se.height,a={text:$,x:e/2,y:t/2,scale:1,rotation:0,fontSize:28,fontFamily:"Arial",color:"#000000",backgroundColor:"white",align:"center"};ee(null),Y(e=>{const t=[...e,a];return J(t.length-1),t})},onMouseDown:e=>{const{x:t,y:a}=de(e);let n=!1,i=!1;for(let o=U.length-1;o>=0;o--){const e=U[o],i=d.current[o];if(i){const{x:e,y:n,size:l}=i,s=t-e,r=a-n;if(Math.sqrt(s*s+r*r)<l/2)return O(e=>e.filter((e,t)=>t!==o)),void ee(null)}if(_(e,t,a)){ee(o),ae("rotate"),ie({x:t,y:a,centerX:e.x+e.img.width*e.scale/2,centerY:e.y+e.img.height*e.scale/2,initialAngle:e.rotation||0}),n=!0;break}if(j(e,t,a)){ee(o),ae("resize"),ie({x:t,y:a,initialScale:e.scale,initialWidth:e.img.width}),n=!0;break}if(M(e,t,a)){ee(o),ae("move"),ie({x:t,y:a,initialX:e.x,initialY:e.y}),n=!0;break}}if(!n)for(let o=L.length-1;o>=0;o--){var l;const e=L[o],n=he(e),s=null===(l=h.current)||void 0===l?void 0:l[o];if(s){const{x:e,y:i}=s,l=L[o].scale||1,r=t-e,c=a-i;let d=.9;l<.5?d=3.5:l<.6?d=3:l<.7?d=2.4:l<.8?d=1.9:l<.93&&(d=1.6);if(Math.sqrt(r*r+c*c)/d<Math.max(20,.01*n*l))return Y(e=>e.filter((e,t)=>t!==o)),void J(null)}if(N(e,t,a,n)){J(o),ae("rotate-text"),ie({x:t,y:a,centerX:e.x,centerY:e.y,initialAngle:e.rotation||0}),i=!0;break}if(C(e,t,a,n)){J(o),ee(null),ae("resize-text"),ie({x:t,y:a,initialScale:e.scale,initialWidth:n}),i=!0;break}if(I(e,t,a,n)){J(o),ae("move-text"),ie({x:t,y:a,initialX:e.x,initialY:e.y}),i=!0;break}}n||i||(ee(null),J(null),ae(null),ie(null))},onMouseMove:e=>{const{x:t,y:a}=de(e);let n="default",i=!1;for(let s=L.length-1;s>=0;s--){const e=L[s],l=he(e);if(N(e,t,a,l)){n="crosshair",i=!0;break}if(C(e,t,a,l)){n="nwse-resize",i=!0;break}if(I(e,t,a,l)){n="grab",i=!0;break}}if(!i)for(let s=U.length-1;s>=0;s--){const e=U[s];if(_(e,t,a)){n="crosshair",i=!0;break}if(j(e,t,a)){n="nwse-resize",i=!0;break}if(M(e,t,a)){n="grab",i=!0;break}}if("move"!==te||null===Z&&null===V||(n="grabbing"),oe(n),!te||!ne)return;const l=t-ne.x,o=a-ne.y;null!==Z&&O(e=>{const n=[...e],i={...n[Z]};if("move"===te)i.x=ne.initialX+l,i.y=ne.initialY+o;else if("resize"===te){const e=ne.initialWidth*ne.initialScale+l,t=Math.max(.05,e/i.img.width);i.scale=t}else if("rotate"===te){const e=Math.atan2(ne.y-ne.centerY,ne.x-ne.centerX),n=180*(Math.atan2(a-ne.centerY,t-ne.centerX)-e)/Math.PI;i.rotation=(ne.initialAngle+n)%360}return n[Z]=i,n}),null!==V&&Y(e=>{const n=[...e],i={...n[V]};if("move-text"===te)i.x=ne.initialX+l,i.y=ne.initialY+o;else if("resize-text"===te){const e=ne.initialWidth*ne.initialScale+l,t=Math.max(.1,e/he(i));i.scale=t}else if("rotate-text"===te){const e=Math.atan2(ne.y-ne.centerY,ne.x-ne.centerX),n=180*(Math.atan2(a-ne.centerY,t-ne.centerX)-e)/Math.PI;i.rotation=(ne.initialAngle+n)%360}return n[V]=i,n})},onMouseUp:()=>{ae(null),ie(null),oe("default")},canvasElements:L,setCanvasElements:Y,activeTextIndex:V,photoBoothSettings:null!==(l=null===e||void 0===e||null===(r=e.wall)||void 0===r?void 0:r.PhotoBoothSettings)&&void 0!==l?l:{},selectedStickers:U,setActiveStickerIndex:ee,setActiveTextIndex:J}):(0,o.jsx)(R,{rawImage:g,takePhoto:async(e,t)=>{if(!e)return void console.error("Failed to capture screenshot from webcam.");const a=new Image;a.crossOrigin="anonymous",a.src=e,a.onload=async()=>{t?x(a):f(a),re({width:a.width,height:a.height}),await(async e=>{const t=new i.SelfieSegmentation({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${e}`});t.setOptions({modelSelection:1}),t.onResults(e=>{E(e.segmentationMask)});const a=document.createElement("canvas");a.width=e.width,a.height=e.height,a.getContext("2d").drawImage(e,0,0,e.width,e.height);try{await t.send({image:a})}catch(n){console.error("Error sending image to MediaPipe:",n)}})(a)},a.onerror=()=>{console.error("Failed to load captured image.")}},canvasRef:c,canvasCursor:le,setRawImage:x,customisePhoto:()=>{x(null),F(null),B(null),O([]),Y([]),X(null),W(null),J(null),ee(null),b(!0)}})})})]})})})}}}]);