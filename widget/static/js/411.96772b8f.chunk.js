"use strict";(self.webpackChunkembed_widget=self.webpackChunkembed_widget||[]).push([[411,9430],{56214:(e,t,a)=>{a.r(t),a.d(t,{default:()=>B});var n=a(9950),o=a(22332),i=a(80415),s=a(44414);function l(e){let{uploadFile:t}=e;return(0,s.jsx)("div",{className:"pb_cards",children:(0,s.jsxs)("div",{className:"pb_cards_box",children:[(0,s.jsxs)("div",{onClick:()=>t(3),className:"pb_card",children:[(0,s.jsx)("div",{className:"pb_card_icon",children:(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/camera.svg`,alt:"camera"})}),(0,s.jsx)("h3",{className:"pb_card-title",children:"Photobooth"}),(0,s.jsx)("p",{className:"pb_card-description",children:" Add fun filters and effects before you share your masterpiece."})]}),(0,s.jsxs)("div",{onClick:()=>t(2),className:"pb_card",children:[(0,s.jsx)("div",{className:"pb_card_icon",children:(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/snapup.svg`,alt:"snapup"})}),(0,s.jsx)("h3",{className:"pb_card-title",children:"Snap & Share"}),(0,s.jsx)("p",{className:"pb_card-description",children:"Scan the QR code to quickly and easily upload photos from your mobile."})]})]})})}const r=e=>{let{className:t,children:a,icon:n,onClick:o}=e;return(0,s.jsxs)("button",{className:t,onClick:o,children:[n&&(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/${n}.svg`,alt:n}),a]})};var c=a(11766),d=a.n(c);const u=320,h=320,m=[{id:"background",label:"Background"},{id:"frame",label:"Frames"},{id:"sticker",label:"Stickers"},{id:"text",label:"Text"}];var g=a(52867);const x=e=>{let{cameraPermission:t,capturedImage:a,mode:o,counter:l,canvasRef:r,canvasCursor:c,webcamRef:m,onMouseDown:x,onMouseMove:f,onMouseUp:v,canvasElements:p,activeTextIndex:b,setCanvasElements:w,loading:y}=e;const[S,k]=(0,n.useState)("user"),M=e=>e?e.split("\n").length:1,j=(0,n.useMemo)(g.qs,[]),_=e=>{const t=e.target.value;if((null===t||void 0===t?void 0:t.length)<=35){const e=(e=>{if(!r.current||!p[b])return e;const t=p[b],a=document.createElement("canvas").getContext("2d"),n=t.fontSize||16,o=t.fontFamily||"Arial";a.font=`${n}px ${o}`;const i=e.split(/\s+/);let s="",l="";for(let r=0;r<i.length;r++){const e=i[r],t=s?s+" "+e:e,{width:n}=a.measureText(t);n>280&&s?(l+=s+"\n",s=e):s=t}return s&&(l+=s),l})(t);w(t=>t.map((t,a)=>a===b?{...t,text:e}:t))}},I=(0,n.useCallback)(e=>{if(!e||!e.text)return 0;const t=document.createElement("canvas").getContext("2d"),a=e.fontSize||16,n=e.fontFamily||"Arial",o=e.scale||1;t.font=`${a}px ${n}`;const i=e.text.split("\n");let s=0;for(const l of i){const e=t.measureText(l).width;e>s&&(s=e)}return s*o},[p]);return(0,s.jsxs)("div",{className:"pb_user_photo "+(y?"active_blur":""),style:{position:"relative",display:a||"granted"===t?"flex":"none"},children:[console.log(S,"facingModefacingModefacingMode"),"capture"!==o||a?a?(0,s.jsx)("canvas",{ref:r,style:{cursor:c},width:u,height:h,onMouseDown:x,onMouseMove:f,onMouseUp:v,onMouseLeave:v,onTouchStart:function(e){e.preventDefault();const t=e.touches[0],a={clientX:t.clientX,clientY:t.clientY};x(a)},onTouchMove:function(e){e.preventDefault();const t=e.touches[0],a={clientX:t.clientX,clientY:t.clientY};f(a)},onTouchEnd:function(e){e.preventDefault(),v()}}):(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/avatar.png`,alt:"default-avatar",width:u,height:h}):(0,s.jsx)(d(),{ref:m,screenshotFormat:"image/png",width:u,height:h,videoConstraints:{facingMode:S,width:u,height:h},style:{objectFit:"cover",borderRadius:"8px"}}),null===p||void 0===p?void 0:p.map((e,t)=>b===t&&(0,s.jsx)("textarea",{id:`text-${t}`,name:`text-${t}`,value:e.text,onChange:_,wrap:"hard",ref:e=>{e&&e.focus()},style:{position:"absolute",top:e.y-(e.fontSize*e.scale*M(e.text)+5)/2+"px",left:e.x-I(e)/2+"px",width:`${I(e)}px`,height:e.fontSize*e.scale*M(e.text)+6+"px",fontSize:e.fontSize*e.scale+"px",fontFamily:e.fontFamily||"Arial",transform:`rotate(${e.rotation||0}deg)`,textAlign:e.align||"center",transformOrigin:"center center",background:e.backgroundColor||"transparent",color:e.color||"#000",overflow:"hidden",border:"none",outline:"none",padding:0,maxWidth:"300px",wordBreak:"break-word",whiteSpace:"pre-wrap",overflowWrap:"break-word",resize:"vertical"}},t)),j&&!a?(0,s.jsx)("button",{onClick:()=>k(e=>"user"===e?"environment":"user"),children:(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/camera-flip.svg`,alt:"flip-camera"})}):null,l?(0,s.jsxs)("div",{className:"pb_viewframe",children:[(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/viewframe-white@3x.svg`,alt:"viewframe"})," ",(0,s.jsx)("span",{children:l})]}):null]})},f=e=>{let{addSticker:t,loading:a,stickers:n,selectedStickers:o}=e;return(0,s.jsx)("div",{className:"pb_stickers",children:n.map((e,n)=>{const i=null===o||void 0===o?void 0:o.find(t=>(null===t||void 0===t?void 0:t.url)==e);return(0,s.jsx)("img",{onClick:a?null:()=>t(e),style:{cursor:a?"not-allowed":"pointer"},className:i?"active":"",src:e,alt:"sticker",width:64,height:64},n)})})},v=["font","align","color","bg"],p=["Arial","Helvetica","Times New Roman","Georgia","Courier New","Verdana","Tahoma","Trebuchet MS","Comic Sans MS","Impact","Lucida Console","Roboto","Open Sans"],b=["left","center","right"],w=["white","black","transparent"],y=e=>{let{canvasElements:t,setCanvasElements:a,activeTextIndex:n}=e;return(0,s.jsx)("div",{className:"pb_text",children:v.map(e=>{var o,l;return(0,s.jsxs)("div",{className:"pb_text_box",children:[(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/text/${e}.png?v=1`,alt:e,onClick:()=>(e=>{if(null!==n){const d={};if("align"===e){var o,i;const e=null!==(o=null===(i=t[n])||void 0===i?void 0:i.align)&&void 0!==o?o:"center",a=b.find(t=>t===e);d.align=b[(b.indexOf(a)+1)%b.length]}else if("bg"===e){var s,l;const e=null!==(s=null===(l=t[n])||void 0===l?void 0:l.backgroundColor)&&void 0!==s?s:"transparent",a=w.find(t=>t===e);d.backgroundColor=w[(w.indexOf(a)+1)%w.length]}else if("font"===e){var r,c;const e=null!==(r=null===(c=t[n])||void 0===c?void 0:c.fontFamily)&&void 0!==r?r:"Arial",a=p.find(t=>t===e);d.fontFamily=p[(p.indexOf(a)+1)%p.length]}a(e=>e.map((e,t)=>t===n?{...e,...d}:e))}})(e)}),(0,s.jsx)("p",{children:e}),"color"===e&&(0,s.jsx)("input",{type:"color",value:null!==(o=null===(l=t[n])||void 0===l?void 0:l.color)&&void 0!==o?o:"black",onChange:e=>{const t=e.target.value;a(e=>e.map((e,a)=>a===n?{...e,color:t}:e))}})]},e)})})},S=e=>{let{loading:t,imgUrl:a,imgList:n,setImgUrl:o,tabKey:l}=e;return(0,s.jsx)("div",{className:`pb_${l}`,children:[`${i.th}/media/images/photobooth/${l}/none.png`,...n].map((e,n)=>{const i=a?a===e:0===n;return(0,s.jsx)("img",{style:{cursor:t?"not-allowed":"pointer"},src:e,alt:`img-${n}`,className:i?"active":"",width:64,height:64,onClick:t?null:()=>o(0==n?null:e)},n)})})},k=e=>{let{capturedImage:t,uploadFile:a,canvasRef:o,canvasCursor:l,selectedBg:c,setSelectedBg:d,selectedFrame:u,setSelectedFrame:h,addSticker:v,addTextElement:p,onMouseDown:b,onMouseMove:w,onMouseUp:k,canvasElements:M,setCanvasElements:j,activeTextIndex:_,loading:I,selectedStickers:C,photoBoothSettings:N,setActiveStickerIndex:E,setActiveTextIndex:A}=e;const[P,$]=(0,n.useState)("background"),[R,T]=(0,n.useState)([]),[F,z]=(0,n.useState)([]),[B,U]=(0,n.useState)([]);return(0,n.useEffect)(()=>{"text"===P&&p(),"text"!==P?A(null):"sticker"!==P&&E(null)},[P]),(0,n.useEffect)(()=>{const e=(0,g.S3)((null===N||void 0===N?void 0:N.photo_booth_frames)||[]),t=(0,g.S3)((null===N||void 0===N?void 0:N.photo_booth_backgrounds)||[]),a=(0,g.S3)((null===N||void 0===N?void 0:N.photo_booth_stickers)||[]);z(null===e||void 0===e?void 0:e.map(e=>`${i.on}images/photobooth/frames/${e}`)),T(null===t||void 0===t?void 0:t.map(e=>`${i.on}images/photobooth/backgrounds/${e}`)),U(null===a||void 0===a?void 0:a.map(e=>`${i.on}images/photobooth/stickers/${e}`))},[]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"pb_customization",children:[(0,s.jsx)(x,{loading:I,capturedImage:t,canvasRef:o,canvasCursor:l,onMouseDown:b,onMouseMove:w,onMouseUp:k,canvasElements:M,activeTextIndex:_,setCanvasElements:j}),(0,s.jsxs)("div",{className:"pb_tabs",children:[(0,s.jsx)("div",{className:"pb_tabs_list",children:m.map(e=>(0,s.jsx)("button",{onClick:()=>$(e.id),className:P===e.id?"active":"",children:e.label},e.id))}),(0,s.jsx)("div",{className:"pb_tabs_content",children:(0,s.jsx)("div",{className:"pb_tabs_content_box",children:"background"===P?(0,s.jsx)(S,{loading:I,imgUrl:c,imgList:R,setImgUrl:d,tabKey:"backgrounds"}):"frame"===P?(0,s.jsx)(S,{imgUrl:u,imgList:F,setImgUrl:h,tabKey:"frames"}):"sticker"===P?(0,s.jsx)(f,{stickers:B,addSticker:v,loading:I,selectedStickers:C}):"text"===P?(0,s.jsx)(y,{canvasElements:M,setCanvasElements:j,activeTextIndex:_}):null})})]})]}),(0,s.jsx)(r,{className:"pb_continue_buttons",children:"Continue",onClick:()=>{if(null!==o&&void 0!==o&&o.current){const e=o.current;E(null),A(null),setTimeout(()=>{const t=e.toDataURL("image/png");t&&a(2,t)},100)}}})]})};function M(e){return(0,s.jsxs)("div",{className:"pb_header_bar",onClick:e.backAction,children:[(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/arrow-back.svg`,alt:"arrow-back"}),2==e.uploadType&&e.uploadImg?(0,s.jsx)("img",{className:"pb_header_logo",src:e.wall.UgcSettings.onsite_logo,height:20,width:130,alt:""}):(0,s.jsx)("span",{className:"header-title",children:"Create a New Post"})]})}const j=(e,t,a)=>{let n="blob"==t?((e,t)=>{try{const a=e.split(","),n=a[0].match(/:(.*?);/)[1],o=atob(a[1]);let i=o.length;const s=new Uint8Array(i);for(;i--;)s[i]=o.charCodeAt(i);return new File([s],t,{type:n})}catch(a){return console.error("Error converting base64 data to file:",a),null}})(e,"camera.png"):e;if(n){const e=URL.createObjectURL(n);e&&a&&a(e)}},_=(e,t,a)=>{const n=e.img.width*e.scale,o=e.img.height*e.scale;return t>e.x+n-P(15,7)&&t<e.x+n&&a>e.y+o-P(15,7)&&a<e.y+o},I=(e,t,a)=>{const n=e.img.width*e.scale,o=e.img.height*e.scale;return t>e.x&&t<e.x+n&&a>e.y&&a<e.y+o},C=(e,t,a)=>{const{img:n,scale:o,x:i,y:s,rotation:l=0}=e,r=n.width*o,c=n.height*o,d=i+r/2,u=s+c/2,h=r/2,m=-c/2-5,g=l*Math.PI/180,x=t-(d+h*Math.cos(g)-m*Math.sin(g)),f=a-(u+h*Math.sin(g)+m*Math.cos(g));return Math.sqrt(x*x+f*f)<=P(7,7)},N=(e,t,a,n)=>{const o=e.scale||1,i=e.fontSize||20,s=n*P(20),l=e.text.split("\n").length*i*o+20,r=t-e.x,c=a-e.y,d=(e.rotation||0)*Math.PI/180,u=Math.cos(-d),h=Math.sin(-d),m=(r*u-c*h)/o,g=(r*h+c*u)/o;return m>=-s/(2*o)&&m<=s/(2*o)&&g>=-l/(2*o)&&g<=l/(2*o)},E=(e,t,a,n)=>{var o;const i=e.scale||1,s=e.fontSize||20,l=(null===(o=e.text)||void 0===o?void 0:o.split("\n"))||[],r=1.2*s*Math.max(l.length,1)*i+20,c=n*i+20,d=P(16),u=e.x,h=e.y,m=c/2,g=r/2,x=(e.rotation||0)*Math.PI/180,f=t-(u+m*Math.cos(x)-g*Math.sin(x)),v=a-(h+m*Math.sin(x)+g*Math.cos(x));return f*f+v*v<(d/2)**2},A=(e,t,a,n)=>{var o;const i=e.scale||1,s=e.fontSize||20,l=P(16),r=e.x,c=e.y,d=(null===(o=e.text)||void 0===o?void 0:o.split("\n"))||[],u=(n*i+20)/2,h=-(1.2*s*Math.max(d.length,1)*i+20)/2,m=(e.rotation||0)*Math.PI/180,g=t-(r+u*Math.cos(m)-h*Math.sin(m)),x=a-(c+u*Math.sin(m)+h*Math.cos(m));return g*g+x*x<(l/2)**2},P=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(0,g.qs)()?.75*e+t:e};var $=a(69522);const R=e=>{let{imageUrl:t,photoBtnRef:a,customiseImage:o}=e;const l=(0,n.useRef)(null),r=(0,n.useRef)(null),c=(0,n.useRef)(null),d=(0,n.useRef)(1),[u,h]=(0,n.useState)(!0),[m,g]=(0,n.useState)({width:200,height:200}),[x,f]=(0,n.useState)({x:0,y:0}),[v,p]=(0,n.useState)(1),b=320,w=320,y=(0,n.useCallback)(()=>{const e=r.current;if(!e)return console.error("Original image not loaded."),null;const t=document.createElement("canvas");t.width=b,t.height=w;const a=t.getContext("2d"),n=e.naturalWidth/m.width,i=e.naturalHeight/m.height,s=-x.x/v*n,l=-x.y/v*i,c=b/v*n,d=w/v*i;a.drawImage(e,s,l,c,d,0,0,b,w);const u=t.toDataURL("image/png");o(u)},[x,v,m,b,w]);(0,n.useEffect)(()=>{const e=new Image;e.crossOrigin="anonymous",e.onload=()=>{const t=e.width/e.height;let a=b,n=a/t;n>w&&(n=w,a=n*t),g({width:a,height:n}),f({x:(b-a)/2,y:(w-n)/2})},e.src=t},[t]);const S=m.width*v,k=m.height*v,M=e=>{const[t,a]=e,n=t.clientX-a.clientX,o=t.clientY-a.clientY;return Math.sqrt(n*n+o*o)},j=e=>{2===e.touches.length&&(c.current=M(e.touches),d.current=v)},_=e=>{if(2===e.touches.length){e.preventDefault();const t=M(e.touches),a=c.current,n=d.current;if(!a||!n)return;const o=t/a;let i=Math.max(1,n*o);p(i)}};return(0,n.useEffect)(()=>{const e=l.current;if(e)return e.addEventListener("touchstart",j,{passive:!1}),e.addEventListener("touchmove",_,{passive:!1}),()=>{e.removeEventListener("touchstart",j),e.removeEventListener("touchmove",_)}},[v]),(0,n.useEffect)(()=>{const e=setTimeout(()=>{h(!1)},2500);return()=>clearTimeout(e)},[]),(0,s.jsxs)("div",{ref:l,style:{width:b,height:w,border:"2px dashed #aaa",position:"relative",overflow:"hidden",margin:"0px auto 30px",background:"#f9f9f9",touchAction:"none",borderRadius:"8px"},onWheel:e=>{e.preventDefault();const t=e.deltaY<0?.05:-.05,a=Math.max(1,v+t);if(a<=1.01&&S<=b&&k<=w){p(1);const e=(b-m.width)/2,t=(w-m.height)/2;f({x:e,y:t})}else p(a)},children:[(0,s.jsx)($.p,{size:{width:S,height:k},position:x,enableResizing:!1,disableDragging:!1,onDragStop:(e,t)=>{let a=t.x,n=t.y;const o=Math.max(0,S-b),i=Math.max(0,k-w);a=Math.min(Math.max(a,-o),0),n=Math.min(Math.max(n,-i),0),f({x:a,y:n})},style:{zIndex:2,pointerEvents:"auto"},children:(0,s.jsx)("img",{ref:r,src:t,alt:"Editable",style:{width:"100%",height:"100%",objectFit:"cover",userSelect:"none",pointerEvents:"none"}})}),(0,s.jsx)("button",{ref:a,style:{display:"none",position:"absolute",top:10,right:10,zIndex:400},onClick:y,children:"Capture"}),u?(0,s.jsxs)("div",{className:"pb_take_photo_crop",children:[(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/arrow-left.svg`,alt:"arrow-left",width:50,height:50}),(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/arrow-right.svg`,alt:"arrow-right",width:50,height:50})]}):null]})},T=e=>{var t;let{rawImage:a,takePhoto:o,canvasRef:l,canvasCursor:c,setRawImage:d,customisePhoto:u}=e;const h=(0,n.useRef)(null),m=(0,n.useRef)(null),g=(0,n.useRef)(null),[f,v]=(0,n.useState)(null),[p,b]=(0,n.useState)("capture"),[w,y]=(0,n.useState)(0),[S,k]=(0,n.useState)(null),M=(0,n.useCallback)(async()=>{["Smile",3,2,1,0].forEach((e,t)=>{setTimeout(()=>v(e),1e3*t)})},[]),_=(0,n.useCallback)(()=>{b("capture"),d(null)},[]),I=(0,n.useCallback)(e=>{var t,a;const n=null===e||void 0===e||null===(t=e.target)||void 0===t||null===(a=t.files)||void 0===a?void 0:a[0];y(w+1),j(n,"file",e=>o(e,!0))},[w]),C=(0,n.useCallback)(async e=>{var t;b(e),"capture"===e&&await M(),"upload"===e&&null!==h&&void 0!==h&&h.current&&await(null===h||void 0===h||null===(t=h.current)||void 0===t?void 0:t.click())},[]);(0,n.useMemo)(()=>{const e=navigator.userAgent.toLowerCase(),t=/iphone|ipad|ipod|android/.test(e),a=/android/.test(e),n=e.includes("chrome")&&!e.includes("edg"),o=e.includes("edg");let i=null;return t?a&&n&&(i="chrome://settings/content/camera"):n?i="chrome://settings/content/camera":o&&(i="edge://settings/content/camera"),i},[]);(0,n.useEffect)(async()=>{if(0==f&&null!==m&&void 0!==m&&m.current){var e;v(null);const t=await(null===m||void 0===m||null===(e=m.current)||void 0===e?void 0:e.getScreenshot());j(t,"blob",e=>o(e,!0))}},[f]);const N=()=>{m.current&&m.current.srcObject&&(m.current.srcObject.getTracks().forEach(e=>e.stop()),m.current.srcObject=null)};return(0,n.useEffect)(()=>(/Safari/i.test(navigator.userAgent)&&!/Chrome/i.test(navigator.userAgent)||(async()=>{try{N();const e=await navigator.mediaDevices.getUserMedia({video:!0});m.current&&(m.current.srcObject=e),k("granted")}catch(e){if(console.warn("Camera error:",e.name,e.message),navigator.permissions&&navigator.permissions.query)try{const e=await navigator.permissions.query({name:"camera"});return void k(e.state)}catch{console.log("Permissions API not supported (Safari likely)")}k("prompt")}})(),()=>N()),[]),(0,n.useEffect)(()=>{const e=async()=>{try{const e=await navigator.permissions.query({name:"camera"});e.state!==S&&k(e.state)}catch(e){console.warn("Permissions API not fully supported",e)}};return setInterval(e,2e3),()=>{clearInterval(e)}},[S]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"pb_user_photo_box",children:[a?(0,s.jsx)(R,{photoBtnRef:g,imageUrl:null!==(t=null===a||void 0===a?void 0:a.src)&&void 0!==t?t:"",customiseImage:e=>{j(e,"blob",e=>o(e,!1)),setTimeout(u,100)}}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(x,{cameraPermission:S,mode:p,rawImage:a,canvasRef:l,canvasCursor:c,webcamRef:m,counter:f}),(0,s.jsxs)("div",{id:"camera-disabled-message",className:"pb-camera-disabled",style:{display:"granted"===S?"none":"flex"},children:[(0,s.jsx)("img",{src:`${i.th}/media/images/photobooth/camera-disabled.svg`,alt:"camera-disabled"}),(0,s.jsxs)("p",{className:"pb_camera_disabled_text",children:["Please reload and allow camera",(0,s.jsx)("br",{}),"access when prompted."]}),(0,s.jsxs)("p",{className:"pb_camera_disabled_text_bottom",children:["In case this doesn't work, please",(0,s.jsx)("br",{}),"check the camera permissions in ",(0,s.jsx)("br",{}),"your browser settings."]})]})]}),a?(0,s.jsxs)("div",{className:"pb_take_photo",children:[(0,s.jsx)(r,{className:"pb_buttons_transparent",icon:"retake",children:"Retake",onClick:_}),(0,s.jsx)(r,{className:"pb_buttons heighlight",children:"Use Photo",onClick:()=>{var e;return null===g||void 0===g||null===(e=g.current)||void 0===e?void 0:e.click()}})]}):(0,s.jsxs)("div",{className:"pb_user_buttons",children:["granted"===S?(0,s.jsx)(r,{className:"pb_buttons heighlight",icon:"camera",children:"Capture Photo",onClick:()=>C("capture")}):null,(0,s.jsx)(r,{className:"pb_buttons",icon:"upload",children:"Upload From Gallery",onClick:()=>C("upload")})]})]}),(0,s.jsx)("input",{ref:h,type:"file",accept:"image/*",style:{display:"none"},onChange:I},w)]})};var F=a(48768);const z="Your Text Here",B=e=>{var t,a,i,r;const c=(0,n.useRef)(null),d=(0,n.useRef)({}),m=(0,n.useRef)({}),[g,x]=(0,n.useState)(!1),[f,v]=(0,n.useState)(null),[p,b]=(0,n.useState)(null),[w,y]=(0,n.useState)(!1),[S,j]=(0,n.useState)(0),[P,$]=(0,n.useState)(null),[R,B]=(0,n.useState)(null),[U,O]=(0,n.useState)(null),[D,Y]=(0,n.useState)([]),[L,X]=(0,n.useState)([]),[W,q]=(0,n.useState)(null),[H,K]=(0,n.useState)(null),[G,Q]=(0,n.useState)(null),[V,J]=(0,n.useState)(null===e||void 0===e?void 0:e.snapType),[Z,ee]=(0,n.useState)(null),[te,ae]=(0,n.useState)(null),[ne,oe]=(0,n.useState)(null),[ie,se]=(0,n.useState)(null),[le,re]=(0,n.useState)("default"),[ce,de]=(0,n.useState)({width:u,height:h}),ue=e=>{x(e)},he=e=>{const t=c.current,a=t.getBoundingClientRect();return{x:(e.clientX-a.left)*(t.width/a.width),y:(e.clientY-a.top)*(t.height/a.height)}},me=e=>{const t=null===c||void 0===c?void 0:c.current;if(!t||null===e||void 0===e||!e.text)return 0;const a=t.getContext("2d");if(!a)return 0;a.save(),a.font=`${e.fontSize||20}px ${e.fontFamily||"Arial"}`;const n=e.text.split("\n"),o=Math.max(...n.map(e=>a.measureText(e).width));return a.restore(),o};(0,n.useEffect)(()=>{if(!p||!P)return;const e=c.current;if(!e)return;const t=e.getContext("2d"),a=ce.width,n=ce.height;e.width=a,e.height=n;const o=document.createElement("canvas");o.width=a,o.height=n;const i=o.getContext("2d");if(i.clearRect(0,0,a,n),W&&U){const e=document.createElement("canvas");e.width=a,e.height=n;const t=e.getContext("2d");t.drawImage(p,0,0,a,n),t.globalCompositeOperation="destination-in",t.drawImage(P,0,0,a,n),t.globalCompositeOperation="source-over",i.drawImage(U,0,0,a,n),i.drawImage(e,0,0,a,n)}else i.drawImage(p,0,0,a,n);i.globalCompositeOperation="source-over",R&&i.drawImage(R,0,0,a,n),D.forEach((e,t)=>{const a=e.img.width*e.scale,n=e.img.height*e.scale,o=e.x+a/2,s=e.y+n/2;if(i.save(),i.translate(o,s),i.rotate((e.rotation||0)*Math.PI/180),i.drawImage(e.img,-a/2,-n/2,a,n),t===te){i.strokeStyle="#2b2b2b",i.lineWidth=2,i.setLineDash([5,3]),i.strokeRect(-a/2,-n/2,a,n),i.setLineDash([]);const l=8,r="\u2921",c=a/2,u=n/2;i.fillStyle="#000",i.beginPath(),i.arc(c,u,l,0,2*Math.PI),i.fill(),i.fillStyle="white",i.font="bold 16px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText(r,c,u);const h=a/2,m=-n/2-20+20,g=8;i.beginPath(),i.fillStyle="#000",i.arc(h,m,g,0,2*Math.PI),i.fill(),i.fillStyle="#fff",i.font="bold 16px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText("\u27f3",h,m);const x=22,f=-a/2-x/2+5,v=-n/2-x/2+8;d.current[t]={x:o+f*Math.cos(e.rotation*Math.PI/180)-v*Math.sin(e.rotation*Math.PI/180),y:s+f*Math.sin(e.rotation*Math.PI/180)+v*Math.cos(e.rotation*Math.PI/180),size:x},i.beginPath(),i.arc(f,v,8,0,2*Math.PI),i.fillStyle="black",i.fill(),i.fillStyle="#fff",i.font="bold 9px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText("\u2715",f,v)}i.restore()}),L.forEach((e,t)=>{var a;i.save(),i.translate(e.x,e.y),i.rotate(e.rotation*Math.PI/180),i.scale(e.scale,e.scale),i.font=`${e.fontSize}px ${e.fontFamily||"Arial"}`,i.textAlign=e.align||"center",i.textBaseline="middle";const n=(null===(a=e.text)||void 0===a?void 0:a.split("\n"))||[""],o=Math.max(...n.map(e=>i.measureText(e).width)),s=n.length,l=e.fontSize*e.scale,r=o+20,c=l*s+10,d=1.2*l,u=o+20,h=l*n.length+30,g=-u/2;if(e.backgroundColor&&(i.fillStyle=e.backgroundColor,i.fillRect(g,-h/2,u,h)),t!==Z&&(i.fillStyle=e.color||"#000000",n.forEach((e,t)=>{let a=0;"center"==i.textAlign?a=0:"left"==i.textAlign?a=-u/2+10:"right"==i.textAlign&&(a=u/2-10),i.fillText(e,a,t*d-(n.length-1)*d/2)})),t===Z){const a=document.getElementById(`text-${Z}`);a&&e.text==z&&(a.focus(),a.select()),i.strokeStyle="#2b2b2b",i.lineWidth=2,i.setLineDash([5,3]),i.strokeRect(g,-h/2,u,h),i.setLineDash([]);const n=22,o=(e.rotation||0)*Math.PI/180,s=-r/2-n/2,l=-c/2-n/2,d=e.x+s*Math.cos(o)-l*Math.sin(o),x=e.y+s*Math.sin(o)+l*Math.cos(o);m.current[t]={x:d,y:x,size:Math.max(10,n*e.scale)},i.fillStyle="black",i.beginPath(),i.arc(g,-h/2,8,0,2*Math.PI),i.fill(),i.fillStyle="#fff",i.font="bold 10px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText("\u2715",g,-h/2),i.fillStyle="black",i.beginPath(),i.arc(g+u,-h/2,8,0,2*Math.PI),i.fill(),i.fillStyle="white",i.font="bold 14px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText("\u27f3",g+u,-h/2),i.fillStyle="black",i.beginPath(),i.arc(g+u,h/2,8,0,2*Math.PI),i.fill(),i.fillStyle="white",i.font="bold 14px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText("\u2921",g+u,h/2)}i.restore()}),t.clearRect(0,0,a,n),t.drawImage(o,0,0)},[p,P,R,D,te,L,Z,U,w,ce]),(0,n.useEffect)(()=>{if(!W)return void O(null);const e=new Image;e.crossOrigin="anonymous",e.src=`https://cdn.taggbox.com/v7/${W}`,ue(!0),e.onload=()=>{O(e),ue(!1)},e.onerror=()=>{console.error(`Failed to load background image: ${W}`),ue(!1)}},[W]),(0,n.useEffect)(()=>{if(!H)return void B(null);const e=new Image;e.crossOrigin="anonymous",e.src=`https://cdn.taggbox.com/v7/${H}`,ue(!0),e.onload=()=>{B(e),ue(!1)},e.onerror=()=>{console.error(`Failed to load frame image: ${H}`),ue(!1)}},[H]);const ge=(e,t)=>{J(e),Q(t)};return(0,s.jsx)("div",{className:"pb_photo_booth_main",children:(0,s.jsx)("div",{className:"pb_photo_booth_box",children:(0,s.jsxs)("div",{className:"pb_photo_booth_box_inner",children:[(0,s.jsx)(M,{uploadImg:G,uploadType:V,wall:null===e||void 0===e?void 0:e.wall,backAction:()=>{w?(v(p),G&&!S?(y(!0),j(1),J(3)):(y(!1),j(0))):(y(!1),v(null),J(f?G&&2===V?3:V:null===e||void 0===e?void 0:e.snapType))}}),(0,s.jsx)("div",{className:"pb_photo_booth_h "+(w?"":"pb_photo_booth_h_center"),children:1==V?(0,s.jsx)(l,{uploadFile:ge}):(0,s.jsx)(s.Fragment,{children:2===V?(0,s.jsx)(F.default,{isPhotoBooth:G,photoBoothInterface:1,wall:null===e||void 0===e?void 0:e.wall,wallId:null===e||void 0===e||null===(t=e.wall)||void 0===t||null===(a=t.Wall)||void 0===a?void 0:a.id,feeds:null===e||void 0===e?void 0:e.feeds,isFreeAdsStatus:null===e||void 0===e?void 0:e.isFreeAdsStatus}):w?(0,s.jsx)(k,{loading:g,capturedImage:p,uploadFile:ge,canvasRef:c,canvasCursor:le,selectedBg:W,setSelectedBg:q,selectedFrame:H,setSelectedFrame:K,addSticker:e=>{const t=new Image;t.crossOrigin="anonymous",ue(!0),t.src=`https://cdn.taggbox.com/v7/${e}`,t.onload=()=>{ue(!1);const a=ce.width,n=ce.height,o=t.height/t.width*100,i=100/t.width;ee(null),Y(s=>{const l=[...s,{img:t,x:a/2-50,y:n/2-o/2,scale:i,url:e,rotation:0}];return ae(l.length-1),l})},t.onerror=()=>{ue(!1),console.error(`Failed to load sticker image: ${e}`)}},addTextElement:()=>{const e=ce.width,t=ce.height,a={text:z,x:e/2,y:t/2,scale:1,rotation:0,fontSize:28,fontFamily:"Arial",color:"#000000",backgroundColor:"white",align:"center"};ae(null),X(e=>{const t=[...e,a];return ee(t.length-1),t})},onMouseDown:e=>{const{x:t,y:a}=he(e);let n=!1,o=!1;for(let s=D.length-1;s>=0;s--){const e=D[s],o=d.current[s];if(o){const{x:e,y:n,size:i}=o,l=t-e,r=a-n;if(Math.sqrt(l*l+r*r)<i/2)return Y(e=>e.filter((e,t)=>t!==s)),void ae(null)}if(C(e,t,a)){ae(s),oe("rotate"),se({x:t,y:a,centerX:e.x+e.img.width*e.scale/2,centerY:e.y+e.img.height*e.scale/2,initialAngle:e.rotation||0}),n=!0;break}if(_(e,t,a)){ae(s),oe("resize"),se({x:t,y:a,initialScale:e.scale,initialWidth:e.img.width}),n=!0;break}if(I(e,t,a)){ae(s),oe("move"),se({x:t,y:a,initialX:e.x,initialY:e.y}),n=!0;break}}if(!n)for(let s=L.length-1;s>=0;s--){var i;const e=L[s],n=me(e),l=null===(i=m.current)||void 0===i?void 0:i[s];if(l){const{x:e,y:o}=l,i=L[s].scale||1,r=t-e,c=a-o;let d=.9;i<.5?d=3.5:i<.6?d=3:i<.7?d=2.4:i<.8?d=1.9:i<.93&&(d=1.6);if(Math.sqrt(r*r+c*c)/d<Math.max(20,.01*n*i))return X(e=>e.filter((e,t)=>t!==s)),void ee(null)}if(A(e,t,a,n)){ee(s),oe("rotate-text"),se({x:t,y:a,centerX:e.x,centerY:e.y,initialAngle:e.rotation||0}),o=!0;break}if(E(e,t,a,n)){ee(s),ae(null),oe("resize-text"),se({x:t,y:a,initialScale:e.scale,initialWidth:n}),o=!0;break}if(N(e,t,a,n)){ee(s),oe("move-text"),se({x:t,y:a,initialX:e.x,initialY:e.y}),o=!0;break}}n||o||(ae(null),ee(null),oe(null),se(null))},onMouseMove:e=>{const{x:t,y:a}=he(e);let n="default",o=!1;for(let l=L.length-1;l>=0;l--){const e=L[l],i=me(e);if(A(e,t,a,i)){n="crosshair",o=!0;break}if(E(e,t,a,i)){n="nwse-resize",o=!0;break}if(N(e,t,a,i)){n="grab",o=!0;break}}if(!o)for(let l=D.length-1;l>=0;l--){const e=D[l];if(C(e,t,a)){n="crosshair",o=!0;break}if(_(e,t,a)){n="nwse-resize",o=!0;break}if(I(e,t,a)){n="grab",o=!0;break}}if("move"!==ne||null===te&&null===Z||(n="grabbing"),re(n),!ne||!ie)return;const i=t-ie.x,s=a-ie.y;null!==te&&Y(e=>{const n=[...e],o={...n[te]};if("move"===ne)o.x=ie.initialX+i,o.y=ie.initialY+s;else if("resize"===ne){const e=ie.initialWidth*ie.initialScale+i,t=Math.max(.05,e/o.img.width);o.scale=t}else if("rotate"===ne){const e=Math.atan2(ie.y-ie.centerY,ie.x-ie.centerX),n=180*(Math.atan2(a-ie.centerY,t-ie.centerX)-e)/Math.PI;o.rotation=(ie.initialAngle+n)%360}return n[te]=o,n}),null!==Z&&X(e=>{const n=[...e],o={...n[Z]};if("move-text"===ne)o.x=ie.initialX+i,o.y=ie.initialY+s;else if("resize-text"===ne){const e=ie.initialWidth*ie.initialScale+i,t=Math.max(.1,e/me(o));o.scale=t}else if("rotate-text"===ne){const e=Math.atan2(ie.y-ie.centerY,ie.x-ie.centerX),n=180*(Math.atan2(a-ie.centerY,t-ie.centerX)-e)/Math.PI;o.rotation=(ie.initialAngle+n)%360}return n[Z]=o,n})},onMouseUp:()=>{oe(null),se(null),re("default")},canvasElements:L,setCanvasElements:X,activeTextIndex:Z,photoBoothSettings:null!==(i=null===e||void 0===e||null===(r=e.wall)||void 0===r?void 0:r.PhotoBoothSettings)&&void 0!==i?i:{},selectedStickers:D,setActiveStickerIndex:ae,setActiveTextIndex:ee}):(0,s.jsx)(T,{rawImage:f,takePhoto:async(e,t)=>{if(!e)return void console.error("Failed to capture screenshot from webcam.");const a=new Image;a.crossOrigin="anonymous",a.src=e,a.onload=async()=>{t?v(a):b(a),de({width:a.width,height:a.height}),await(async e=>{const t=new o.SelfieSegmentation({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${e}`});t.setOptions({modelSelection:1}),t.onResults(e=>{$(e.segmentationMask)});const a=document.createElement("canvas");a.width=e.width,a.height=e.height,a.getContext("2d").drawImage(e,0,0,e.width,e.height);try{await t.send({image:a})}catch(n){console.error("Error sending image to MediaPipe:",n)}})(a)},a.onerror=()=>{console.error("Failed to load captured image.")}},canvasRef:c,canvasCursor:le,setRawImage:v,customisePhoto:()=>{v(null),B(null),O(null),Y([]),X([]),q(null),K(null),ee(null),ae(null),y(!0)}})})})]})})})}}}]);